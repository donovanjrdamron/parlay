{% comment %}
  Renders cart drawer

  Usage:
  {% render 'cart-drawer' %}
{% endcomment %}

<style>
  /* Allow scrolling behind cart drawer */
  body.overflow-hidden {
    overflow: auto !important;
  }

  /* HIDE ALL CART ERROR MESSAGES */
  #CartDrawer-CartErrors,
  .cart-item__error,
  .cart-item__error-text,
  [id*="CartDrawer-LineItemError"],
  cart-drawer [role="alert"] {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }

  .drawer {
    visibility: hidden;
    overflow-x: hidden;
  }
  .cart-drawer .drawer__header {
    background: {% if section.settings.enable_header_bg %}{{ section.settings.header_bg_color }}{% else %}{{ settings.section_background_color }}{% endif %};
  }
  .cart-drawer__body, .cart-drawer-item {
    background: {% if section.settings.enable_body_bg %}{{ section.settings.body_bg_color }}{% else %}{{ settings.section_background_color }}{% endif %};
    overflow-x: hidden;
  }
  .cart-drawer__body {
    max-width: 100%;
  }
  .cart-drawer .drawer__footer {
    background: {% if section.settings.enable_footer_bg %}{{ section.settings.footer_bg_color }}{% else %}{{ settings.section_background_color }}{% endif %};
  }

  .drawer__header {
    position: relative;
    background-color: rgb(var(--color-background));
    padding: 1rem 1.5rem;
  }

  .drawer__heading {
    margin: 0;
    display: flex;
    align-items: center;
  }

  /* Cart Count Badge Circular Styles */
  .cart-count-badge {
    background-color: {{ section.settings.cart_badge_bg_color }};
    color: {{ section.settings.cart_badge_text_color }};
    border: 2px solid {{ section.settings.cart_badge_border_color }};
    border-radius: 50%;
    width: {{ section.settings.cart_badge_size }}px;
    height: {{ section.settings.cart_badge_size }}px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: {{ section.settings.cart_badge_font_size }}px;
    font-weight: {{ section.settings.cart_badge_font_weight }};
    line-height: 1;
    margin-left: 0.5em;
    flex-shrink: 0;
  }

  .cart-drawer-item {
    display: flex;
    align-items: center;
    gap: 0;
    margin-bottom: 0;
    position: relative;
    flex-direction: row;
    flex-wrap: wrap;
  }

  .cart-item__image {
    border-radius: var(--image-border-radius, 8px);
  }

  .cart-item__subscription-upgrade {
    width: calc(100% - var(--image-size-desktop, 150px) - 1.5rem);
    padding: var(--btn-spacing-top, 12px) 0 0 0;
    margin-left: calc(var(--image-size-desktop, 150px) + 1.5rem);
    order: 999;
    flex-basis: auto;
  }

  /* Custom styles when override is enabled */
  .cart-item__subscription-upgrade--custom {
    padding: var(--btn-spacing-top, 12px) 0 0 0 !important;
  }

  /* Toggle button style layout - Row on one line */
  .cart-item__subscription-upgrade--toggle {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: var(--btn-spacing-top, 12px) 0 0 0 !important;
  }

  /* Grouped toggle style - text and toggle together on right */
  .cart-item__subscription-upgrade--toggle.cart-item__subscription-upgrade--grouped {
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__text {
    flex: 0 0 auto;
    font-size: var(--btn-font-size, 14px);
    font-weight: var(--btn-font-weight, 500);
    color: var(--btn-text-color, #000000);
    white-space: nowrap;
  }

  .cart-item__subscription-upgrade--toggle.cart-item__subscription-upgrade--grouped .subscription-upgrade__text {
    width: auto;
    white-space: nowrap;
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle {
    position: relative;
    display: inline-block;
    width: var(--toggle-width, 50px);
    height: var(--toggle-height, 28px);
    margin-left: 0;
    flex-shrink: 0;
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--toggle-inactive-color, #ccc);
    transition: 0.3s;
    border-radius: var(--toggle-height, 28px);
    display: block;
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle-slider:before {
    position: absolute;
    content: "";
    height: calc(var(--toggle-height, 28px) - 8px);
    width: calc(var(--toggle-height, 28px) - 8px);
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle input:checked + .subscription-upgrade__toggle-slider {
    background-color: var(--toggle-active-color, #000000);
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle input:checked + .subscription-upgrade__toggle-slider:before {
    transform: translateX(calc(var(--toggle-width, 50px) - var(--toggle-height, 28px)));
  }

  /* Ensure toggle is always visible and interactive */
  .cart-item__subscription-upgrade--toggle {
    visibility: visible !important;
    opacity: 1 !important;
  }

  .subscription-upgrade__toggle,
  .subscription-upgrade__toggle-slider {
    visibility: visible !important;
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  /* Loading state for toggle - spin in place at left position */
  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle-slider.loading {
    opacity: 1 !important;
  }

  .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle-slider.loading:before {
    animation: subscription-toggle-spin 0.6s linear infinite !important;
    background: linear-gradient(45deg, #fff 0%, #ccc 100%) !important;
  }

  @keyframes subscription-toggle-spin {
    0% { transform: translateX(0) rotate(0deg); }
    100% { transform: translateX(0) rotate(360deg); }
  }

  .cart-item__upgrade-button {
    width: 100%;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .cart-item__upgrade-button .upgrade-button__spinner {
    align-items: center;
    justify-content: center;
    line-height: 0;
  }

  .cart-item__upgrade-button .upgrade-button__spinner .spinner-svg {
    animation: button-spinner 0.8s linear infinite;
    display: block;
  }

  @keyframes button-spinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .cart-item__upgrade-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* Custom button styles when override is enabled */
  .cart-item__upgrade-button--custom {
    padding: var(--btn-padding-vertical) var(--btn-padding-horizontal) !important;
    font-size: var(--btn-font-size) !important;
    font-weight: var(--btn-font-weight) !important;
    color: var(--btn-text-color) !important;
    background: var(--btn-bg-color) !important;
    border: var(--btn-border-width) solid var(--btn-border-color) !important;
    border-radius: var(--btn-border-radius) !important;
  }

  .cart-item__upgrade-button--custom:hover:not(:disabled) {
    background: var(--btn-hover-bg-color) !important;
    color: var(--btn-hover-text-color) !important;
    border-color: var(--btn-hover-bg-color) !important;
  }

  .cart-item__upgrade-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Mobile Responsive Fixes for Cart Items */
  @media screen and (max-width: 749px) {
    .cart-drawer-item {
      gap: 0.75rem;
    }

    .cart-item__media {
      width: var(--image-size-mobile, 100px) !important;
      min-width: var(--image-size-mobile, 100px) !important;
      flex-shrink: 0 !important;
    }

    .cart-drawer-item__right {
      flex: 1 1 0 !important;
      min-width: 0 !important;
      max-width: calc(100% - var(--image-size-mobile, 100px) - 0.75rem) !important;
      overflow: visible !important;
    }

    .cart-drawer-item__details-and-delete-btn {
      max-width: 100% !important;
      min-width: 0 !important;
    }

    .cart-item__details {
      max-width: calc(100% - 40px) !important;
      min-width: 0 !important;
    }

    .cart-item__name {
      font-size: var(--title-font-size-mobile, 14px) !important;
      max-width: 100% !important;
    }

    .cart-item__subscription-upgrade {
      width: calc(100% - var(--image-size-mobile, 100px) - 0.75rem) !important;
      margin-left: calc(var(--image-size-mobile, 100px) + 0.75rem) !important;
      padding: var(--btn-spacing-top, 8px) 0 0 0 !important;
    }

    .cart-item__subscription-upgrade--toggle {
      flex-wrap: nowrap !important;
      gap: 8px !important;
    }

    .cart-item__subscription-upgrade--toggle .subscription-upgrade__text {
      font-size: 12px !important;
      white-space: nowrap !important;
    }

    .cart-item__subscription-upgrade--toggle .subscription-upgrade__toggle {
      flex-shrink: 0 !important;
    }

    /* Grouped style on mobile */
    .cart-item__subscription-upgrade--toggle.cart-item__subscription-upgrade--grouped {
      justify-content: flex-end !important;
    }
  }

  /* Hide footer when cart is empty */
  cart-drawer.is-empty .drawer__footer,
  cart-drawer.is-empty .drawer__footer *,
  cart-drawer.is-empty .cart-drawer__footer,
  cart-drawer.is-empty .cart__ctas,
  cart-drawer.is-empty #CartDrawer-Checkout,
  cart-drawer.is-empty .cart__checkout-button,
  cart-drawer.is-empty .cart__dynamic-checkout-buttons {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    overflow: hidden !important;
    opacity: 0 !important;
  }

  /* CRITICAL FIX: Override base CSS that hides footer */
  cart-drawer:not(.is-empty) .drawer__footer {
    height: auto !important;
    padding: 0 !important;
    overflow: visible !important;
    display: flex !important;
    flex-direction: column !important;
  }

  /* Remove scroll from cart items */
  .drawer__contents {
    overflow: visible !important;
    max-height: none !important;
  }

  .drawer__cart-items-wrapper {
    overflow: visible !important;
    max-height: none !important;
  }

  .cart-items {
    overflow: visible !important;
  }

  /* Scrollable section for upsells and other blocks */
  .drawer__footer-scrollable {
    max-height: 300px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding: 0 1.5rem !important;
  }

  /* Force visibility of subtotals and checkout - these are OUTSIDE scrollable area */
  .cart-drawer .drawer__footer .cart-drawer__footer {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    height: auto !important;
    padding: 0 1.5rem !important;
    flex-shrink: 0 !important;
  }

  .cart-drawer .drawer__footer .cart__ctas {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    height: auto !important;
    padding: 0 1.5rem !important;
    flex-shrink: 0 !important;
  }

  #CartDrawer-Checkout {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  /* Guarantee Badge Styling */
  .guarantee-badge {
    margin-top: var(--margin-top, 1.2rem);
    margin-bottom: var(--margin-bottom, 1.2rem);
    padding: 0 1.5rem;
  }

  .guarantee-badge__content {
    display: flex;
    align-items: center;
    justify-content: var(--alignment, center);
    gap: 8px;
  }

  .guarantee-badge__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--icon-size, 20px);
    height: var(--icon-size, 20px);
    color: var(--icon-color, #4CAF50);
    flex-shrink: 0;
  }

  .guarantee-badge__icon svg {
    width: 100%;
    height: 100%;
  }

  /* Fix for long product titles in cart */
  .cart-item__name {
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
    word-break: break-word !important;
    hyphens: auto !important;
    line-height: 1.3 !important;
    max-width: 100% !important;
    flex: 1 1 auto !important;
    min-width: 0 !important;
    margin: 0 !important;
    font-size: var(--title-font-size-desktop, 16px) !important;
    font-weight: var(--title-font-weight, 600) !important;
    color: var(--title-color, #1a1a1a) !important;
  }

  .cart-item__name.h4 {
    max-width: 100% !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-size: var(--title-font-size-desktop, 16px) !important;
    font-weight: var(--title-font-weight, 600) !important;
    color: var(--title-color, #1a1a1a) !important;
  }

  /* Ensure parent container doesn't overflow */
  .cart-item__details {
    overflow: hidden !important;
    flex: 1 1 auto !important;
    min-width: 0 !important;
    max-width: 100% !important;
  }

  /* Style the direct child div (title + savings badge wrapper) */
  .cart-item__details > div {
    display: flex !important;
    align-items: flex-start !important;
    gap: 8px !important;
    flex-wrap: wrap !important;
    min-width: 0 !important;
  }

  /* Override margin-top for quantity and prices when has props */
  .cart-drawer-item__quantity-and-prices--has-props {
    margin-top: 1.5rem !important;
  }

  .cart-drawer-item__details-and-delete-btn {
    display: flex !important;
    align-items: flex-start !important;
    gap: 10px !important;
    overflow: hidden !important;
    flex: 1 1 auto !important;
    min-width: 0 !important;
    max-width: 100% !important;
  }

  .cart-drawer-item__right {
      flex: 1 1 0 !important;
      min-width: 0 !important;
      max-width: calc(100% - var(--image-size-mobile, 100px) - 0.75rem) !important;
      overflow: visible !important;
    }

  /* Constrain title container div */
  .cart-item__details > div {
    max-width: 100% !important;
    overflow: hidden !important;
    min-width: 0 !important;
    flex: 1 1 auto !important;
  }

  .cart-item__details > div > * {
    max-width: 100% !important;
    min-width: 0 !important;
  }

  /* Force title to stay within bounds - override inline styles */
  .cart-item__name.h4.break,
  .cart-item__name.break,
  a.cart-item__name.h4.break {
    max-width: 100% !important;
    width: 100% !important;
    flex: 1 1 0 !important;
    min-width: 0 !important;
    white-space: normal !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
    hyphens: auto !important;
  }

  .cart-drawer-item__cart-remove-button {
    flex-shrink: 0 !important;
    width: 30px !important;
    min-width: 30px !important;
  }

  .guarantee-badge__text {
    font-size: var(--font-size, 14px);
    font-weight: var(--font-weight, 500);
    color: var(--text-color, #000000);
    line-height: 1.4;
  }

  /* Social Proof Bar Styling */
  .social-proof-bar {
    margin-top: var(--margin-top, 1.2rem);
    margin-bottom: var(--margin-bottom, 1.2rem);
    padding: 0 1.5rem;
  }

  /* Full width version - edge to edge */
  .social-proof-bar--full-width {
    margin-left: -1.5rem;
    margin-right: -1.5rem;
    padding: 0;
    width: calc(100% + 3rem);
  }

  .social-proof-bar--full-width .social-proof-bar__content {
    padding: 0 1.5rem;
  }

  .social-proof-bar--full-width.social-proof-bar--with-bg {
    padding: var(--padding-vertical, 12px) 0;
    border-radius: 0;
  }

  .social-proof-bar--with-bg {
    position: relative;
    border-radius: var(--border-radius, 8px);
    padding: var(--padding-vertical, 12px) 1.5rem;
    margin-left: -1.5rem;
    margin-right: -1.5rem;
    backdrop-filter: blur(var(--backdrop-blur, 0px));
    -webkit-backdrop-filter: blur(var(--backdrop-blur, 0px));
    overflow: hidden;
  }

  /* Background layer with opacity - doesn't affect text */
  .social-proof-bar--with-bg::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-color, #F5F5F5);
    opacity: var(--bg-opacity, 1);
    z-index: -1;
  }

  .social-proof-bar__content {
    display: flex;
    align-items: center;
    justify-content: var(--alignment, center);
    gap: 10px;
    position: relative;
    z-index: 1;
  }

  .social-proof-bar__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--icon-size, 20px);
    height: var(--icon-size, 20px);
    color: var(--icon-color, #4CAF50);
    flex-shrink: 0;
  }

  .social-proof-bar__icon svg {
    width: 100%;
    height: 100%;
  }

  .social-proof-bar__text {
    font-size: var(--font-size, 14px);
    font-weight: var(--font-weight, 500);
    color: var(--text-color, #000000);
    line-height: 1.4;
  }

  /* Payment Badges - Pinned to bottom */
  .cart-drawer__payment-badges {
    margin-top: var(--margin-top, 1.5rem);
    margin-bottom: var(--margin-bottom, 1.5rem);
    padding: 0 1.5rem;
  }

  .payment-badges-block {
    width: 100%;
  }

  /* Custom HTML Block */
  .custom-html-block {
    margin-top: var(--margin-top, 1.5rem);
    margin-bottom: var(--margin-bottom, 1.5rem);
  }

  .custom-html-block--body,
  .custom-html-block--footer {
    padding: 0 var(--padding-horizontal, 1.5rem);
  }

  .custom-html-block--heading {
    display: flex;
    align-items: center;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
  }

  .payment-badges {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--badge-gap, 8px);
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .payment-badges .list-payment__item {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .payment-badges .icon {
    height: var(--badge-height, 30px);
    width: auto;
  }
</style>

<cart-drawer class="drawer{% if cart == empty %} is-empty{% endif %}{% if section.settings.test_mode %} active{% endif %} cart-drawer--desktop-width-{{ section.settings.desktop_width }} cart-drawer--mobile-width-{{ section.settings.mobile_width }}" data-type='modal'>
  <div id="CartDrawer" class="cart-drawer">
    <div id="CartDrawer-Overlay" class="cart-drawer__overlay" onclick="this.closest('cart-drawer').close()"></div>
    <div
      class="drawer__inner"
      role="dialog"
      aria-modal="true"
      aria-label="{{ 'sections.cart.title' | t }}"
      tabindex="-1"
    >
      {%- if cart == empty -%}
        <div class="drawer__inner-empty">
          <div class="cart-drawer__warnings center{% if settings.cart_drawer_collection != blank %} cart-drawer__warnings--has-collection{% endif %}">
            <div class="cart-drawer__empty-content">
              <h2 class="cart__empty-text">{{ 'sections.cart.empty' | t }}</h2>
              <button
                class="drawer__close"
                type="button"
                onclick="this.closest('cart-drawer').close()"
                aria-label="{{ 'accessibility.close' | t }}"
              >
                {% render 'icon-close' %}
              </button>
              {% if settings.display_continue_shopping %}
                <a href="{% if settings.continue_shopping_url == blank %}{{ routes.all_products_collection_url }}{% else %}{{ settings.continue_shopping_url }}{% endif %}" class="button">
                  {{ 'general.continue_shopping' | t }}
                </a>
              {% endif %}

              {%- if shop.customer_accounts_enabled and customer == null -%}
                <p class="cart__login-title h3">{{ 'sections.cart.login.title' | t }}</p>
                <p class="cart__login-paragraph">
                  {{ 'sections.cart.login.paragraph_html' | t: link: routes.account_login_url }}
                </p>
              {%- endif -%}
            </div>
          </div>
          {%- if settings.cart_drawer_collection != blank -%}
            <div class="cart-drawer__collection">
              {% render 'card-collection', card_collection: settings.cart_drawer_collection, columns: 1 %}
            </div>
          {%- endif -%}
        </div>
      {%- endif -%}
      <div class="drawer__header" style='--alignment:{{ section.settings.heading_alignment }};{% if section.settings.heading_text_color != blank %}--heading-color:{{ section.settings.heading_text_color }};{% endif %}'>
        <h2 class="drawer__heading"{% if section.settings.heading_text_color != blank %} style="color: {{ section.settings.heading_text_color }};"{% endif %}>
          {% liquid
            assign non_upsell_count = cart.item_count
            for item in cart.items
              if item.product.tags contains 'cart-hidden'
                assign non_upsell_count = non_upsell_count | minus: 1
              endif
            endfor
          %}
          {% capture count_badge %}<span class="cart-count-badge">{{ non_upsell_count }}</span>{% endcapture %}
          {{ section.settings.heading_text | replace: '[count]', count_badge }}
        </h2>

        {%- comment -%} Custom HTML blocks positioned in heading (right side) {%- endcomment -%}
        {% for block in section.blocks %}
          {% if block.type == 'custom_html' and block.settings.position == 'heading' %}
            <div class="custom-html-block custom-html-block--heading" {{ block.shopify_attributes }}>
              {{ block.settings.html_content }}
            </div>
          {% endif %}
        {% endfor %}

        <button
          class="drawer__close"
          type="button"
          onclick="this.closest('cart-drawer').close()"
          aria-label="{{ 'accessibility.close' | t }}"
          {% if section.settings.heading_text_color != blank %}style="color: {{ section.settings.heading_text_color }};"{% endif %}
        >
          {% render 'icon-close' %}
        </button>
      </div>

      <div class="cart-drawer__body">
        {% if section.blocks.size == 0 %}
          <h3 class='h3 center'>To customize the cart, add blocks to the Cart drawer section (under the Header group)</h3>
        {% endif %}
        {% assign total_compare_price = 0 %}

        {%- comment -%} Find countdown timer with banner overlay position {%- endcomment -%}
        {% assign countdown_overlay_block = nil %}
        {% for block in section.blocks %}
          {% if block.type == 'countdown_timer' and block.settings.position == 'banner_overlay' %}
            {% assign countdown_overlay_block = block %}
            {% break %}
          {% endif %}
        {% endfor %}

        {%- comment -%} Find social proof with cart_banner position {%- endcomment -%}
        {% assign social_proof_block = nil %}
        {% for block in section.blocks %}
          {% if block.type == 'social_proof' and block.settings.position == 'cart_banner' %}
            {% assign social_proof_block = block %}
            {% break %}
          {% endif %}
        {% endfor %}

        {%- comment -%} Find checkpoints bar with banner overlay position {%- endcomment -%}
        {% assign checkpoints_overlay_block = nil %}
        {% for block in section.blocks %}
          {% if block.type == 'checkpoints_bar' and block.settings.position contains 'banner_overlay' %}
            {% assign checkpoints_overlay_block = block %}
            {% break %}
          {% endif %}
        {% endfor %}

        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'cart_banner' %}
              {% render 'cart-banner', block: block, countdown_block: countdown_overlay_block, social_proof_block: social_proof_block, checkpoints_block: checkpoints_overlay_block, items_count: non_upsell_count %}
            {% when 'progress_bar' %}
              {% render 'cart-progress-bar', block: block, items_count: non_upsell_count %}
            {% when 'checkpoints_bar' %}
              {%- comment -%} Only render in body if position is set to body {%- endcomment -%}
              {% if block.settings.position == 'body' %}
                {% render 'cart-checkpoints-bar', block: block, items_count: non_upsell_count %}
              {% endif %}
            {% when 'countdown_timer' %}
              {%- comment -%} Only render in body if position is set to body {%- endcomment -%}
              {% if block.settings.position == 'body' %}
                {% if block.settings.show_boxed_timer %}
                  {%- comment -%} Boxed timer with styling {%- endcomment -%}
                  {% capture boxed_timer %}
                    <span class="holiday-clock">
                      {% unless block.settings.hide_hours %}
                        <span class="box-3">
                          <span class="clock-number-2" data-timer-hours>00</span>
                          <span class="clock-label-2">Hrs</span>
                        </span>
                        <span class="text-block-countdown">:</span>
                      {% endunless %}
                      <span class="box-3">
                        <span class="clock-number-2" data-timer-minutes>00</span>
                        <span class="clock-label-2">Min</span>
                      </span>
                      <span class="text-block-countdown">:</span>
                      <span class="box-3">
                        <span class="clock-number-2" data-timer-seconds>00</span>
                        <span class="clock-label-2">Sec</span>
                      </span>
                    </span>
                  {% endcapture %}

                  <div
                    class='cart-timer cart-timer--styled{% unless block.settings.overlay_use_container %} cart-timer--full-width{% endunless %}'
                    style="
                      --overlay-bg: {{ block.settings.overlay_background | default: '#000000' }};
                      --overlay-text-color: {{ block.settings.overlay_text_color | default: '#ffffff' }};
                      --font-size: {{ block.settings.font_size | default: 1.4 }}rem;
                      --text-font-size: {{ block.settings.text_font_size | default: 14 }}px;
                      --overlay-blur: {{ block.settings.overlay_blur | default: 0 }}px;
                      --overlay-opacity: {{ block.settings.overlay_bg_opacity | default: 70 | divided_by: 100.0 }};
                      --overlay-padding-vertical: {{ block.settings.overlay_padding_vertical | default: 10 }}px;
                      --overlay-padding-horizontal: {{ block.settings.overlay_padding_horizontal | default: 15 }}px;
                      --overlay-border-width: {{ block.settings.overlay_border_width | default: 0 }}px;
                      --overlay-border-color: {{ block.settings.overlay_border_color | default: '#ffffff' }};
                      --overlay-border-radius: {{ block.settings.overlay_border_radius | default: 0 }}px;
                      --timer-box-bg: {{ block.settings.timer_box_bg_color | default: '#ffffff' }};
                      --timer-number-color: {{ block.settings.timer_number_color | default: '#2a2552' }};
                      --timer-number-size: {{ block.settings.timer_number_font_size | default: 14 }}px;
                      --timer-number-weight: {{ block.settings.timer_number_font_weight | default: 900 }};
                      --timer-label-size: {{ block.settings.timer_label_font_size | default: 8 }}px;
                      --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
                      --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
                      margin-top: {{ block.settings.overlay_margin_top }}px;
                      margin-bottom: {{ block.settings.overlay_margin_bottom }}px;
                    "
                    {{ block.shopify_attributes }}
                    data-timer-duration="{{ block.settings.timer_duration }}"
                    data-boxed-timer="true"
                  >
                    {{ block.settings.timer_text | replace: '[timer]', boxed_timer }}
                  </div>
                {% else %}
                  {%- comment -%} Standard countdown-timer {%- endcomment -%}
                  {% capture timer %}
                    <countdown-timer data-duration="{{ block.settings.timer_duration }}"></countdown-timer>
                  {% endcapture %}
                  <div
                    class='cart-timer cart-timer--styled{% unless block.settings.overlay_use_container %} cart-timer--full-width{% endunless %}'
                    style="
                      --overlay-bg: {{ block.settings.overlay_background | default: '#000000' }};
                      --overlay-text-color: {{ block.settings.overlay_text_color | default: '#ffffff' }};
                      --font-size: {{ block.settings.font_size | default: 1.4 }}rem;
                      --text-font-size: {{ block.settings.text_font_size | default: 14 }}px;
                      --timer-font-size: {{ block.settings.timer_font_size | default: 18 }}px;
                      --overlay-blur: {{ block.settings.overlay_blur | default: 0 }}px;
                      --overlay-opacity: {{ block.settings.overlay_bg_opacity | default: 70 | divided_by: 100.0 }};
                      --overlay-padding-vertical: {{ block.settings.overlay_padding_vertical | default: 10 }}px;
                      --overlay-padding-horizontal: {{ block.settings.overlay_padding_horizontal | default: 15 }}px;
                      --overlay-border-width: {{ block.settings.overlay_border_width | default: 0 }}px;
                      --overlay-border-color: {{ block.settings.overlay_border_color | default: '#ffffff' }};
                      --overlay-border-radius: {{ block.settings.overlay_border_radius | default: 0 }}px;
                      --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
                      --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
                      margin-top: {{ block.settings.overlay_margin_top }}px;
                      margin-bottom: {{ block.settings.overlay_margin_bottom }}px;
                    "
                    {{ block.shopify_attributes }}
                  >
                    {{ block.settings.timer_text | replace: '[timer]', timer }}
                  </div>
                {% endif %}

                <style>
                  .cart-timer--styled {
                    text-align: center;
                    color: var(--overlay-text-color, #fff);
                    padding: var(--overlay-padding-vertical, 10px) var(--overlay-padding-horizontal, 15px);
                    font-size: var(--text-font-size, 14px);
                    line-height: 1.4;
                    backdrop-filter: blur(var(--overlay-blur, 0px));
                    -webkit-backdrop-filter: blur(var(--overlay-blur, 0px));
                    border: var(--overlay-border-width, 0px) solid var(--overlay-border-color, #fff);
                    border-radius: var(--overlay-border-radius, 0px);
                    position: relative;
                    overflow: hidden;
                    width: 100%;
                    margin-left: auto;
                    margin-right: auto;
                  }

                  /* Non-boxed timer font size */
                  .cart-timer--styled countdown-timer {
                    font-size: var(--timer-font-size, 18px);
                    font-weight: 700;
                  }

                  /* Full width variant - breaks out of cart padding */
                  .cart-timer--full-width {
                    margin-left: -1.5rem !important;
                    margin-right: -1.5rem !important;
                    width: calc(100% + 3rem);
                    border-radius: 0 !important;
                  }

                  .cart-timer--styled::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: var(--overlay-bg, #000);
                    opacity: var(--overlay-opacity, 0.7);
                    z-index: -1;
                  }

                  .cart-timer--styled .holiday-clock {
                    display: inline-flex;
                    justify-content: center;
                    align-items: center;
                    gap: 2px;
                    vertical-align: middle;
                  }

                  .cart-timer--styled .box-3 {
                    display: inline-flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    background-color: var(--timer-box-bg, #fff);
                    border-radius: 2px;
                    width: 30px;
                    height: 40px;
                    margin: 0 2px;
                    padding: 3px;
                    font-size: 12px;
                    line-height: 20px;
                    color: var(--timer-number-color, #2a2552);
                  }

                  .cart-timer--styled .clock-number-2 {
                    font-size: var(--timer-number-size, 14px);
                    font-weight: var(--timer-number-weight, 900);
                    line-height: 1;
                    color: var(--timer-number-color, #2a2552);
                  }

                  .cart-timer--styled .clock-label-2 {
                    font-size: var(--timer-label-size, 8px);
                    line-height: 1;
                    text-transform: uppercase;
                    color: var(--timer-number-color, #2a2552);
                  }

                  .cart-timer--styled .text-block-countdown {
                    color: var(--overlay-text-color, #fff);
                    padding: 0 2.5px;
                    font-weight: 800;
                    font-size: 18px;
                  }

                  @media screen and (max-width: 749px) {
                    .cart-timer--styled .box-3 {
                      width: 25px;
                      height: 28px;
                    }

                    .cart-timer--styled .clock-number-2 {
                      font-size: calc(var(--timer-number-size, 14px) * 0.9);
                    }

                    .cart-timer--styled .clock-label-2 {
                      font-size: calc(var(--timer-label-size, 8px) * 0.85);
                    }
                  }

                  @media screen and (max-width: 379px) {
                    .cart-timer--styled .box-3 {
                      width: 22px;
                      height: 32px;
                    }

                    .cart-timer--styled .text-block-countdown {
                      padding: 0 2px;
                    }
                  }
                </style>

                <script>
                (function() {
                  'use strict';

                  function initCartBodyTimer() {
                    const timer = document.querySelector('.cart-timer--styled[data-boxed-timer="true"]');
                    if (!timer) return;

                    const duration = parseInt(timer.dataset.timerDuration) || 90;
                    const hoursEl = timer.querySelector('[data-timer-hours]');
                    const minutesEl = timer.querySelector('[data-timer-minutes]');
                    const secondsEl = timer.querySelector('[data-timer-seconds]');

                    if (!minutesEl || !secondsEl) return;

                    let remainingSeconds = duration;

                    function formatNumber(num) {
                      return num.toString().padStart(2, '0');
                    }

                    function updateTimer() {
                      if (remainingSeconds < 0) {
                        remainingSeconds = 0;
                      }

                      const hours = Math.floor(remainingSeconds / 3600);
                      const minutes = Math.floor((remainingSeconds % 3600) / 60);
                      const seconds = remainingSeconds % 60;

                      if (hoursEl) {
                        hoursEl.textContent = formatNumber(hours);
                      }
                      minutesEl.textContent = formatNumber(minutes);
                      secondsEl.textContent = formatNumber(seconds);

                      if (remainingSeconds > 0) {
                        remainingSeconds--;
                      }
                    }

                    updateTimer();
                    setInterval(updateTimer, 1000);
                  }

                  if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initCartBodyTimer);
                  } else {
                    initCartBodyTimer();
                  }

                  document.addEventListener('cart:refresh', function() {
                    setTimeout(initCartBodyTimer, 100);
                  });
                })();
                </script>
              {% endif %}
            {% when 'delivery_date' %}
              {% if block.settings.position == 'body' %}
                {% render 'delivery-date', block: block %}
              {% endif %}
            {% when 'cart_customer_review' %}
              {% render 'customer-review-card', block: block %}
            {% when 'cart_items' %}
              <cart-drawer-items
                {% if cart == empty %}
                  class=" is-empty"
                {% endif %}
                style="--image-size-desktop: {{ block.settings.image_size_desktop }}px;--image-size-mobile: {{ block.settings.image_size_mobile }}px;--image-border-radius: {{ block.settings.image_border_radius | default: 8 }}px;--title-font-size-desktop: {{ block.settings.title_font_size_desktop }}px;--title-font-size-mobile: {{ block.settings.title_font_size_mobile }}px;--title-font-weight: {{ block.settings.title_font_weight }};--title-color: {{ block.settings.title_color }};--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;"
                {{ block.shopify_attributes }}
              >
                <form
                  action="{{ routes.cart_url }}"
                  id="CartDrawer-Form"
                  class="cart__contents cart-drawer__form"
                  method="post"
                >
                  <div id="CartDrawer-CartItems" class="drawer__contents js-contents">
                    {%- if cart != empty -%}
                      <div class="drawer__cart-items-wrapper">
                        <ul class="cart-items list-unstyled">
                          {%- for item in cart.items -%}
                            <li 
                              id="CartDrawer-Item-{{ item.index | plus: 1 }}" 
                              class="cart-drawer-item cart-item cart-item--product-{{ item.product.handle }}" 
                              role="row" data-index="{{ item.index | plus: 1 }}"
                            >
                              <div class="loading-overlay hidden">
                                <div class="loading-overlay__spinner">
                                  <svg
                                    aria-hidden="true"
                                    focusable="false"
                                    class="spinner"
                                    viewBox="0 0 66 66"
                                    xmlns="http://www.w3.org/2000/svg"
                                  >
                                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                                  </svg>
                                </div>
                              </div>
                              <div class="cart-item__media" role="cell">
                                {% if item.image %}
                                  {% comment %} Leave empty space due to a:empty CSS display: none rule {% endcomment %}
                                  {% if block.settings.image_link %}<a href="{{ item.url }}" class="cart-item__link" tabindex="-1" aria-hidden="true"> </a>{% endif %}
                                  <img
                                    class="cart-item__image"
                                    src="{{ item.image | image_url: width: block.settings.image_size_desktop }}"
                                    alt="{{ item.image.alt | escape }}"
                                    loading="lazy"
                                    width="{{ block.settings.image_size_desktop }}"
                                    height="{{ block.settings.image_size_desktop | divided_by: item.image.aspect_ratio | ceil }}"
                                  >
                                {% endif %}
                              </div>

                              <div class='cart-drawer-item__right'>
                                {% liquid 
                                  assign display_compare = false
                                  assign compare_price = 0
                                  assign has_props = false
                                  for variant in item.product.variants
                                    if variant.id == item.id 
                                      assign current_variant = variant
                                    endif
                                  endfor
                                  
                                  if block.settings.displayed_compare_prices == 'automatic'
                                    if item.original_line_price != item.final_line_price 
                                      assign display_compare = true
                                      assign compare_price = item.original_line_price
                                    elsif current_variant.compare_at_price > item.final_price
                                      assign display_compare = true
                                      assign compare_price = current_variant.compare_at_price | times: item.quantity
                                    endif
                                  elsif block.settings.displayed_compare_prices == 'product' and current_variant.compare_at_price > item.final_price
                                    assign display_compare = true
                                    assign compare_price = current_variant.compare_at_price | times: item.quantity
                                  elsif item.original_line_price != item.final_line_price
                                    assign display_compare = true
                                    assign compare_price = item.original_line_price
                                  endif
                                %}
                                <div class='cart-drawer-item__details-and-delete-btn'>
                                  <div class="cart-item__details" role="cell" headers="CartDrawer-ColumnProduct">
                                    {%- if settings.show_vendor -%}
                                      <p class="caption-with-letter-spacing light">{{ item.product.vendor }}</p>
                                    {%- endif -%}
        
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-width: 0;">
                                      <{% if block.settings.title_link %}a href="{{ item.url }}"{% else %}h4{% endif %} class="cart-item__name h4 break" style="margin: 0; flex: 1 1 auto; min-width: 0;">
                                        {{- item.product.title | escape -}}
                                      </{% if block.settings.title_link %}a{% else %}h4{% endif %}>

                                      {%- if block.settings.display_savings_badge -%}
                                        {%- liquid
                                          assign show_savings = false
                                          assign compare_price = 0
                                          assign actual_price = item.final_price

                                          if item.variant.compare_at_price and item.variant.compare_at_price > actual_price
                                            assign compare_price = item.variant.compare_at_price
                                            assign show_savings = true
                                          elsif item.original_price > actual_price
                                            assign compare_price = item.original_price
                                            assign show_savings = true
                                          endif
                                        -%}
                                        {%- if show_savings -%}
                                          {%- liquid
                                            assign per_unit_savings = compare_price | minus: actual_price
                                            assign total_savings = per_unit_savings | times: item.quantity

                                            if block.settings.savings_badge_use_theme_colors
                                              assign badge_text_color = settings.badge_text_color | default: '#FFFFFF'
                                              assign badge_bg_color = settings.badge_bg_color | default: '#FF0000'
                                              assign badge_border_color = settings.badge_border_color | default: '#000000'
                                              assign badge_font_size = settings.badge_font_size | default: 12
                                              assign badge_font_weight = settings.badge_font_weight | default: '600'
                                              assign badge_padding_v = settings.badge_padding_vertical | default: 4
                                              assign badge_padding_h = settings.badge_padding_horizontal | default: 8
                                              assign badge_border_width = settings.badge_border_width | default: 1
                                              assign badge_border_radius = settings.badge_border_radius | default: 4
                                              assign badge_text_template = settings.badge_text | default: 'Save [percentage]%'
                                            else
                                              assign badge_text_color = block.settings.savings_badge_text_color
                                              assign badge_bg_color = block.settings.savings_badge_bg_color
                                              assign badge_border_color = block.settings.savings_badge_border_color
                                              assign badge_font_size = block.settings.savings_badge_font_size
                                              assign badge_font_weight = block.settings.savings_badge_font_weight
                                              assign badge_padding_v = block.settings.savings_badge_padding_vertical
                                              assign badge_padding_h = block.settings.savings_badge_padding_horizontal
                                              assign badge_border_width = block.settings.savings_badge_border_width
                                              assign badge_border_radius = block.settings.savings_badge_border_radius
                                              assign badge_text_template = block.settings.savings_badge_text | default: 'Save [percentage]%'
                                            endif

                                            assign savings_percent = per_unit_savings | times: 100 | divided_by: compare_price
                                            assign price_savings_formatted = total_savings | money_without_trailing_zeros
                                            assign badge_display_text = badge_text_template | replace: '[percentage]', savings_percent | replace: '[price]', price_savings_formatted
                                          -%}
                                          <div class="cart-item__savings-badge" style="
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 4px;
                                            padding: {{ badge_padding_v }}px {{ badge_padding_h }}px;
                                            background-color: {{ badge_bg_color }};
                                            border: {{ badge_border_width }}px solid {{ badge_border_color }};
                                            border-radius: {{ badge_border_radius }}px;
                                            font-size: {{ badge_font_size }}px;
                                            font-weight: {{ badge_font_weight }};
                                            color: {{ badge_text_color }};
                                            white-space: nowrap;
                                          ">
                                            {{ badge_display_text }}
                                          </div>
                                        {%- endif -%}
                                      {%- endif -%}

                                      {%- if block.settings.display_discount_badge and item.discounts.size > 0 -%}
                                        <div class="cart-drawer__discounts list-unstyled" role="list" aria-label="{{ 'customer.order.discount' | t }}" style="margin: 0;">
                                          {%- for discount in item.discounts -%}
                                            <div class="badge" style="color: {{ block.settings.discount_badge_text_color }}; background-color: {{ block.settings.discount_badge_bg_color }}; border: {{ block.settings.discount_badge_border_width }}px solid {{ block.settings.discount_badge_border_color }}; border-radius: {{ block.settings.discount_badge_border_radius }}px; padding: {{ block.settings.discount_badge_padding_vertical }}px {{ block.settings.discount_badge_padding_horizontal }}px; font-size: {{ block.settings.discount_badge_font_size }}px; font-weight: {{ block.settings.discount_badge_font_weight }}; display: inline-flex; align-items: center; gap: 5px;">
                                              {%- if block.settings.discount_badge_icon_type == 'default' -%}
                                                <span style="color: {{ block.settings.discount_badge_icon_color }}; display: inline-flex; align-items: center; flex-shrink: 0; width: {{ block.settings.discount_badge_icon_size }}px; height: {{ block.settings.discount_badge_icon_size }}px;">
                                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 100%; height: 100%;">
                                                    <path fill-rule="evenodd" d="M5.25 2.25a3 3 0 00-3 3v4.318a3 3 0 00.879 2.121l9.58 9.581c.92.92 2.39 1.186 3.548.428a18.849 18.849 0 005.441-5.44c.758-1.16.492-2.629-.428-3.548l-9.58-9.581a3 3 0 00-2.122-.879H5.25zM6.375 7.5a1.125 1.125 0 100-2.25 1.125 1.125 0 000 2.25z" clip-rule="evenodd"/>
                                                  </svg>
                                                </span>
                                              {%- elsif block.settings.discount_badge_icon_type == 'custom' and block.settings.discount_badge_custom_svg != blank -%}
                                                <span style="color: {{ block.settings.discount_badge_icon_color }}; display: inline-flex; align-items: center; flex-shrink: 0; width: {{ block.settings.discount_badge_icon_size }}px; height: {{ block.settings.discount_badge_icon_size }}px;">
                                                  {{ block.settings.discount_badge_custom_svg }}
                                                </span>
                                              {%- endif -%}
                                              <span>{{ discount.title }}</span>
                                            </div>
                                          {%- endfor -%}
                                        </div>
                                      {%- endif -%}
                                    </div>

                                    {%- if item.product.has_only_default_variant == false
                                      or item.properties != blank
                                      or item.selling_plan_allocation != null
                                    -%}
                                      {% assign has_props = true %}
                                      <dl>
                                        {%- if item.product.has_only_default_variant == false -%}
                                          {% if block.settings.displayed_variants == 'compact' %}
                                            <div class="product-option">
                                              {{ item.options_with_values | map: 'value' | join: ' / ' }}
                                            </div>
                                          {% else %}
                                            {%- for option in item.options_with_values -%}
                                              <div class="product-option">
                                                <dt>{{ option.name }}:</dt>
                                                <dd>
                                                  {{ option.value -}}
                                                  {%- unless forloop.last %}, {% endunless %}
                                                </dd>
                                              </div>
                                            {%- endfor -%}
                                          {% endif %}
                                        {%- endif -%}
        
                                        {%- for property in item.properties -%}
                                          {%- assign property_first_char = property.first | slice: 0 -%}
                                          {%- if property.last != blank and property_first_char != '_' -%}
                                            <div class="product-option">
                                              <dt>{{ property.first }}:</dt>
                                              <dd>
                                                {%- if property.last contains '/uploads/' -%}
                                                  <a
                                                    href="{{ property.last }}"
                                                    class="link"
                                                    target="_blank"
                                                    aria-describedby="a11y-new-window-message"
                                                  >
                                                    {{ property.last | split: '/' | last }}
                                                  </a>
                                                {%- else -%}
                                                  {{ property.last }}
                                                {%- endif -%}
                                              </dd>
                                            </div>
                                          {%- endif -%}
                                        {%- endfor -%}
                                      </dl>

                                      {%- unless block.settings.show_subscription_badge -%}
                                        <p class="product-option">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                                      {%- endunless -%}
                                    {%- endif -%}
                                  </div>
                                  <cart-remove-button
                                    class='cart-drawer-item__cart-remove-button'
                                    id="CartDrawer-Remove-{{ item.index | plus: 1 }}"
                                    data-index="{{ item.index | plus: 1 }}"
                                  >
                                    <button
                                      type="button"
                                      class="button button--tertiary"
                                      aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}"
                                    >
                                      {% render 'icon-remove' %}
                                    </button>
                                  </cart-remove-button>
                                </div>

                                <div class='cart-drawer-item__quantity-and-prices{% if block.settings.prices_position == 'left' %} cart-drawer-item__quantity-and-prices--reverse{% endif %}{% if has_props != false %} cart-drawer-item__quantity-and-prices--has-props{% endif %}'>
                                  <div class="cart-item__quantity">
                                    <div class="cart-item__quantity-wrapper">
                                      <quantity-input
                                        class="quantity cart-quantity{% if block.settings.quantity_round_btns %} cart-quantity--round-btns{% endif %}{% if block.settings.quantity_outline_btns %} cart-quantity--outline-btns{% endif %}"
                                        style='
                                          --font-size:{{ block.settings.quantity_font_size | divided_by: 10.0 }}rem;
                                          --border-width:0.{{ block.settings.quantity_border_width }}rem;
                                          --border-color:{{ block.settings.quantity_border_color }};
                                          --corner-radius:{{ block.settings.quantity_corner_radius | divided_by: 10.0 }}rem;
                                          --container-padding:{{ block.settings.quantity_container_padding }}em;
                                          --input-padding:{{ block.settings.quantity_input_padding }}em;
                                          --separator-opacity:{{ block.settings.quantity_separators_opacity | divided_by: 100.0 }};
                                          --padding:{{ block.settings.quantity_padding }}em;
                                          --icon-size:{{ block.settings.quantity_btns_icon_size | divided_by: 100.0 }}em;
                                          --quantity-input-bg:{{ block.settings.quantity_input_background }};
                                          --quantity-button-bg:{{ block.settings.quantity_buttons_background }};
                                        '
                                      >
                                        <button class="quantity__button quantity__button--minus no-js-hidden" name="minus" type="button" style="background-color: {{ block.settings.quantity_buttons_background }}; color: {{ block.settings.quantity_buttons_icon_color }}; border: {{ block.settings.quantity_buttons_border_width }}px solid {{ block.settings.quantity_buttons_border_color }};">
                                          <span class="visually-hidden">
                                            {{-
                                              'products.product.quantity.decrease'
                                              | t: product: item.product.title
                                              | escape
                                            -}}
                                          </span>
                                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill='currentColor'>
                                            <path d="M432 256c0 17.7-14.3 32-32 32L48 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l352 0c17.7 0 32 14.3 32 32z"/>
                                          </svg>
                                        </button>
                                        <input
                                          class="quantity__input"
                                          type="number"
                                          data-quantity-variant-id="{{ item.variant.id }}"
                                          name="updates[]"
                                          value="{{ item.quantity }}"
                                          {% # theme-check-disable %}
                                          data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
                                          min="{{ item.variant.quantity_rule.min }}"
                                          {% if item.variant.quantity_rule.max != null %}
                                            max="{{ item.variant.quantity_rule.max }}"
                                          {% endif %}
                                          step="{{ item.variant.quantity_rule.increment }}"
                                          {% # theme-check-enable %}
                                          aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                                          id="Drawer-quantity-{{ item.index | plus: 1 }}"
                                          data-index="{{ item.index | plus: 1 }}"
                                          style="background-color: {{ block.settings.quantity_input_background }}"
                                        >
                                        <button class="quantity__button quantity__button--plus no-js-hidden" name="plus" type="button" style="background-color: {{ block.settings.quantity_buttons_background }}; color: {{ block.settings.quantity_buttons_icon_color }}; border: {{ block.settings.quantity_buttons_border_width }}px solid {{ block.settings.quantity_buttons_border_color }};">
                                          <span class="visually-hidden">
                                            {{-
                                              'products.product.quantity.increase'
                                              | t: product: item.product.title
                                              | escape
                                            -}}
                                          </span>
                                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill='currentColor'>
                                            <path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/>
                                          </svg>
                                        </button>
                                      </quantity-input>
                                    </div>
        
                                    <div
                                      id="CartDrawer-LineItemError-{{ item.index | plus: 1 }}"
                                      class="cart-item__error"
                                      role="alert"
                                    >
                                      <small class="cart-item__error-text"></small>
                                      <svg
                                        aria-hidden="true"
                                        focusable="false"
                                        class="icon icon-error"
                                        viewBox="0 0 13 13"
                                      >
                                        <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
                                        <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
                                        <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
                                        <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
                                      </svg>
                                    </div>
                                  </div>
                                  
                                  <div class="cart-item__totals {{ block.settings.prices_position }}" role="cell">
                                    <div class="cart-item__price-wrapper" {% if block.settings.show_subscription_badge and item.selling_plan_allocation != null %}style="position: relative; top: -10px;"{% endif %}>
                                      {%- if item.final_line_price == 0 -%}
                                        {%- comment -%} Show FREE badge when price is 0 {%- endcomment -%}
                                        <div class="cart-item__free-badge-wrapper">
                                          <span class="cart-item__free-badge" style="
                                            background-color: {{ block.settings.free_badge_bg_color }};
                                            color: {{ block.settings.free_badge_text_color }};
                                            font-size: {{ block.settings.free_badge_font_size }}px;
                                            display: inline-block;
                                            padding: {{ block.settings.free_badge_padding_vertical }}px {{ block.settings.free_badge_padding_horizontal }}px;
                                            border-radius: {{ block.settings.free_badge_border_radius }}px;
                                            border: {{ block.settings.free_badge_border_width }}px solid {{ block.settings.free_badge_border_color }};
                                            font-weight: {{ block.settings.free_badge_font_weight }};
                                            line-height: 1;
                                            text-transform: uppercase;
                                          ">
                                            {{ block.settings.free_badge_text }}
                                          </span>
                                        </div>
                                      {%- elsif display_compare -%}
                                        {% liquid
                                          assign item_saving = compare_price | minus: item.final_line_price
                                          assign total_compare_price = total_compare_price | plus: compare_price
                                        %}
                                        <div class="cart-item__discounted-prices">
                                          <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
                                          <s class="cart-item__old-price price--end compare-price" style="color: {{ block.settings.item_compare_price_color }}; font-size: {{ block.settings.compare_price_font_size }}px; letter-spacing: 0; margin-right: 5px;">
                                            {{ compare_price | money }}
                                          </s>
                                          <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
                                          <span class="price--end regular-price" style="color: {{ block.settings.item_price_color }}; font-size: {{ block.settings.price_font_size }}px; letter-spacing: 0;">
                                            {{ item.final_line_price | money }}
                                          </span>
                                        </div>
                                      {% else %}
                                        {% liquid
                                          assign total_compare_price = total_compare_price | plus: item.original_line_price
                                        %}
                                        <span class="price--end regular-price" style="color: {{ block.settings.item_price_color }}; font-size: {{ block.settings.price_font_size }}px; letter-spacing: 0;">
                                          {{ item.original_line_price | money }}
                                        </span>
                                      {% endif %}
        
                                      {%- if item.variant.available and item.unit_price_measurement -%}
                                        <div class="unit-price caption">
                                          <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
                                          {{ item.variant.unit_price | money }}
                                          <span aria-hidden="true">/</span>
                                          <span class="visually-hidden"
                                            >&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span
                                          >
                                          {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                                            {{- item.variant.unit_price_measurement.reference_value -}}
                                          {%- endif -%}
                                          {{ item.variant.unit_price_measurement.reference_unit }}
                                        </div>
                                      {%- endif -%}

                                      {%- if block.settings.show_subscription_badge and item.selling_plan_allocation != null -%}
                                        <span class="cart-item__subscription-badge" style="
                                          background-color: {{ block.settings.subscription_badge_bg }};
                                          color: {{ block.settings.subscription_badge_text_color }};
                                          font-size: {{ block.settings.subscription_badge_font_size }}px;
                                          display: inline-block;
                                          padding: {{ block.settings.subscription_badge_padding_vertical }}px {{ block.settings.subscription_badge_padding_horizontal }}px;
                                          border-radius: {{ block.settings.subscription_badge_border_radius }}px;
                                          border: {{ block.settings.subscription_badge_border_width }}px solid {{ block.settings.subscription_badge_border_color }};
                                          margin-top: 6px;
                                          font-weight: 600;
                                          line-height: 1;
                                          text-transform: uppercase;
                                        ">
                                          {{ block.settings.subscription_badge_text }}
                                        </span>
                                      {%- endif -%}
                                    </div>
                                  </div>
                                </div>
                              </div>

                              {%- comment -%} Subscription upgrade button - inside cart item at bottom {%- endcomment -%}
                              {%- if block.settings.show_subscription_upgrade and item.selling_plan_allocation == null -%}
                                {%- liquid
                                  assign has_subscription = false
                                  assign subscription_plan_id = ''
                                  assign subscription_discount = 0

                                  for i in (1..10)
                                    assign product_key = 'subscription_product_' | append: i
                                    assign plan_id_key = 'subscription_product_' | append: i | append: '_id'
                                    assign discount_key = 'subscription_product_' | append: i | append: '_discount'
                                    assign setting_product = settings[product_key]
                                    assign setting_plan_id = settings[plan_id_key]
                                    assign setting_discount = settings[discount_key]

                                    if setting_product.id == item.product.id and setting_plan_id != blank
                                      assign has_subscription = true
                                      assign subscription_plan_id = setting_plan_id
                                      assign subscription_discount = setting_discount
                                      break
                                    endif
                                  endfor
                                -%}

                                {%- if has_subscription -%}
                                  {%- liquid
                                    assign discount_text_template = block.settings.subscription_upgrade_discount_text | default: 'Subscribe and save <strong>[discount]%</strong>'

                                    if subscription_discount > 0
                                      assign button_text = discount_text_template | replace: '[discount]', subscription_discount
                                    else
                                      assign text_parts = discount_text_template | split: '[discount]'
                                      assign button_text = text_parts[0] | strip
                                    endif
                                  -%}

                                  {%- if block.settings.subscription_upgrade_toggle_style -%}
                                    {%- comment -%} Toggle button style {%- endcomment -%}
                                    <div class="cart-item__subscription-upgrade cart-item__subscription-upgrade--toggle{% if block.settings.subscription_upgrade_toggle_grouped %} cart-item__subscription-upgrade--grouped{% endif %}" style="
                                      --toggle-width: {{ block.settings.subscription_upgrade_toggle_width }}px;
                                      --toggle-height: {{ block.settings.subscription_upgrade_toggle_height }}px;
                                      --toggle-active-color: {{ block.settings.subscription_upgrade_toggle_active_color }};
                                      --toggle-inactive-color: {{ block.settings.subscription_upgrade_toggle_inactive_color }};{% if block.settings.override_subscription_upgrade_button %}
                                      --btn-font-size: {{ block.settings.subscription_upgrade_font_size }}px;
                                      --btn-font-weight: {{ block.settings.subscription_upgrade_font_weight }};
                                      --btn-text-color: {{ block.settings.subscription_upgrade_text_color }};
                                      --btn-bg-color: {{ block.settings.subscription_upgrade_bg_color }};{% endif %}
                                      --btn-spacing-top: {{ block.settings.subscription_upgrade_spacing_top }}px;
                                    ">
                                      <div class="subscription-upgrade__text">{{ button_text }}</div>
                                      <label class="subscription-upgrade__toggle">
                                        <input
                                          type="checkbox"
                                          class="subscription-upgrade__toggle-input"
                                          data-variant-id="{{ item.variant.id }}"
                                          data-quantity="{{ item.quantity }}"
                                          data-line-index="{{ item.index | plus: 1 }}"
                                          data-selling-plan-id="{{ subscription_plan_id }}"
                                        >
                                        <span class="subscription-upgrade__toggle-slider"></span>
                                      </label>
                                    </div>
                                  {%- else -%}
                                    {%- comment -%} Regular button style {%- endcomment -%}
                                    <div class="cart-item__subscription-upgrade{% if block.settings.override_subscription_upgrade_button %} cart-item__subscription-upgrade--custom{% endif %}" {% if block.settings.override_subscription_upgrade_button %}style="
                                      --btn-font-size: {{ block.settings.subscription_upgrade_font_size }}px;
                                      --btn-font-weight: {{ block.settings.subscription_upgrade_font_weight }};
                                      --btn-text-color: {{ block.settings.subscription_upgrade_text_color }};
                                      --btn-bg-color: {{ block.settings.subscription_upgrade_bg_color }};
                                      --btn-border-color: {{ block.settings.subscription_upgrade_border_color }};
                                      --btn-border-width: {{ block.settings.subscription_upgrade_border_width }}px;
                                      --btn-border-radius: {{ block.settings.subscription_upgrade_border_radius }}px;
                                      --btn-padding-vertical: {{ block.settings.subscription_upgrade_padding_vertical }}px;
                                      --btn-padding-horizontal: {{ block.settings.subscription_upgrade_padding_horizontal }}px;
                                      --btn-hover-text-color: {{ block.settings.subscription_upgrade_hover_text_color }};
                                      --btn-hover-bg-color: {{ block.settings.subscription_upgrade_hover_bg_color }};
                                      --btn-spacing-top: {{ block.settings.subscription_upgrade_spacing_top }}px;
                                    "{% endif %}>
                                      <button
                                        type="button"
                                        class="cart-item__upgrade-button{% if block.settings.override_subscription_upgrade_button %} cart-item__upgrade-button--custom{% else %} button button--tertiary{% endif %}"
                                        data-variant-id="{{ item.variant.id }}"
                                        data-quantity="{{ item.quantity }}"
                                        data-line-index="{{ item.index | plus: 1 }}"
                                        data-selling-plan-id="{{ subscription_plan_id }}"
                                      >
                                        <span class="upgrade-button__text">{{ button_text }}</span>
                                        <span class="upgrade-button__spinner" style="display: none;">
                                          <svg width="20" height="20" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg" class="spinner-svg">
                                            <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" stroke-dasharray="80" stroke-dashoffset="60" stroke-linecap="round"/>
                                          </svg>
                                        </span>
                                      </button>
                                    </div>
                                  {%- endif -%}
                                {%- endif -%}
                              {%- endif -%}
                            </li>
                          {%- endfor -%}
                        </ul>
                      </div>
                    {%- endif -%}
                    <p id="CartDrawer-LiveRegionText" class="visually-hidden" role="status"></p>
                    <p id="CartDrawer-LineItemStatus" class="visually-hidden" aria-hidden="true" role="status">
                      {{ 'accessibility.loading' | t }}
                    </p>
                  </div>
                  <div id="CartDrawer-CartErrors" role="alert"></div>
                </form>
              </cart-drawer-items>

              <script>
                (function() {
                  'use strict';

                  // Suppress any console errors related to this feature
                  window.addEventListener('error', function(e) {
                    if (e.message && (e.message.includes('cart') || e.message.includes('subscription'))) {
                      e.preventDefault();
                      e.stopPropagation();
                      return false;
                    }
                  }, true);

                  async function upgradeToSubscription(variantId, quantity, lineIndex, sellingPlanId) {
                    try {
                      // Remove item
                      await fetch('/cart/change.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ line: lineIndex, quantity: 0 })
                      });

                      await new Promise(r => setTimeout(r, 600));

                      // Add with subscription
                      await fetch('/cart/add.js', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                          items: [{ id: variantId, quantity: quantity, selling_plan: sellingPlanId }]
                        })
                      });

                      await new Promise(r => setTimeout(r, 500));

                      // Get fresh cart
                      const res = await fetch(window.location.pathname + '?sections=cart-drawer');
                      const sections = await res.json();

                      if (sections['cart-drawer']) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(sections['cart-drawer'], 'text/html');
                        const newInner = doc.querySelector('.drawer__inner');
                        const currentInner = document.querySelector('cart-drawer .drawer__inner');

                        if (newInner && currentInner) {
                          currentInner.innerHTML = newInner.innerHTML;
                          setTimeout(initSubscriptionUpgrade, 300);
                        }
                      }

                      return true;
                    } catch (e) {
                      return false;
                    }
                  }

                  // Make function globally accessible
                  window.initSubscriptionUpgrade = function() {
                    // Handle regular buttons
                    const upgradeButtons = document.querySelectorAll('.cart-item__upgrade-button');

                    upgradeButtons.forEach(button => {
                      // Skip if already initialized
                      if (button.dataset.initialized === 'true') return;
                      button.dataset.initialized = 'true';

                      button.addEventListener('click', async function(e) {
                        try {
                          e.preventDefault();

                          // Clear any cart errors immediately
                          const errorDiv = document.getElementById('CartDrawer-CartErrors');
                          if (errorDiv) errorDiv.innerHTML = '';

                          const variantId = this.dataset.variantId;
                          const quantity = parseInt(this.dataset.quantity);
                          const lineIndex = parseInt(this.dataset.lineIndex);
                          const sellingPlanId = this.dataset.sellingPlanId;

                          // Show loading overlay on cart item
                          const cartItem = this.closest('.cart-drawer-item');
                          const loadingOverlay = cartItem ? cartItem.querySelector('.loading-overlay') : null;
                          if (loadingOverlay) {
                            loadingOverlay.classList.remove('hidden');
                          }

                          const success = await upgradeToSubscription(variantId, quantity, lineIndex, sellingPlanId);

                          // Clear errors again
                          if (errorDiv) errorDiv.innerHTML = '';

                          if (!success && loadingOverlay) {
                            loadingOverlay.classList.add('hidden');
                          }
                        } catch (err) {
                          // Silently handle any errors and clear error div
                          const errorDiv = document.getElementById('CartDrawer-CartErrors');
                          if (errorDiv) errorDiv.innerHTML = '';

                          const cartItem = this.closest('.cart-drawer-item');
                          const loadingOverlay = cartItem ? cartItem.querySelector('.loading-overlay') : null;
                          if (loadingOverlay) {
                            loadingOverlay.classList.add('hidden');
                          }
                        }
                      });
                    });

                    // Handle toggle switches
                    const toggleInputs = document.querySelectorAll('.subscription-upgrade__toggle-input');

                    toggleInputs.forEach(toggle => {
                      // Skip if already initialized
                      if (toggle.dataset.initialized === 'true') return;
                      toggle.dataset.initialized = 'true';

                      toggle.addEventListener('change', async function(e) {
                        try {
                          // Make sure it's checked
                          if (!this.checked) {
                            return;
                          }

                          // Clear any cart errors immediately
                          const errorDiv = document.getElementById('CartDrawer-CartErrors');
                          if (errorDiv) errorDiv.innerHTML = '';

                          const variantId = this.dataset.variantId;
                          const quantity = parseInt(this.dataset.quantity);
                          const lineIndex = parseInt(this.dataset.lineIndex);
                          const sellingPlanId = this.dataset.sellingPlanId;

                          // Show loading overlay on cart item
                          const cartItem = this.closest('.cart-drawer-item');
                          const loadingOverlay = cartItem ? cartItem.querySelector('.loading-overlay') : null;
                          if (loadingOverlay) {
                            loadingOverlay.classList.remove('hidden');
                          }

                          // Disable toggle during processing
                          this.disabled = true;

                          const success = await upgradeToSubscription(variantId, quantity, lineIndex, sellingPlanId);

                          // Clear errors again
                          if (errorDiv) errorDiv.innerHTML = '';

                          if (!success) {
                            if (loadingOverlay) loadingOverlay.classList.add('hidden');
                            this.disabled = false;
                            this.checked = false;
                          }
                        } catch (err) {
                          // Silently handle any errors and clear error div
                          const errorDiv = document.getElementById('CartDrawer-CartErrors');
                          if (errorDiv) errorDiv.innerHTML = '';

                          this.disabled = false;
                          this.checked = false;
                        }
                      });
                    });
                  }

                  // Prevent cart error div from ever showing content
                  function suppressCartErrors() {
                    const errorDiv = document.getElementById('CartDrawer-CartErrors');
                    if (errorDiv) {
                      const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                          if (errorDiv.innerHTML !== '') {
                            errorDiv.innerHTML = '';
                          }
                        });
                      });
                      observer.observe(errorDiv, { childList: true, subtree: true });
                    }
                  }

                  // Initialize on page load
                  if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                      initSubscriptionUpgrade();
                      suppressCartErrors();
                    });
                  } else {
                    initSubscriptionUpgrade();
                    suppressCartErrors();
                  }

                  // Re-initialize after cart updates
                  document.addEventListener('cart:refresh', function() {
                    setTimeout(function() {
                      initSubscriptionUpgrade();
                      suppressCartErrors();
                    }, 100);
                  });

                  // Watch for cart drawer content changes and auto-initialize
                  let lastInitTime = 0;
                  function observeCartDrawer() {
                    const cartDrawer = document.querySelector('cart-drawer .drawer__inner');
                    if (!cartDrawer) {
                      setTimeout(observeCartDrawer, 100);
                      return;
                    }

                    const observer = new MutationObserver(function(mutations) {
                      // Prevent too frequent re-initialization
                      const now = Date.now();
                      if (now - lastInitTime < 100) return;

                      // Check if cart items were actually modified
                      const hasCartChanges = mutations.some(mutation => {
                        return mutation.type === 'childList' && mutation.addedNodes.length > 0;
                      });

                      if (hasCartChanges) {
                        lastInitTime = now;
                        // Use multiple timeouts for iOS compatibility
                        setTimeout(function() {
                          initSubscriptionUpgrade();
                          suppressCartErrors();
                        }, 100);
                        setTimeout(function() {
                          initSubscriptionUpgrade();
                          suppressCartErrors();
                        }, 300);
                        setTimeout(function() {
                          initSubscriptionUpgrade();
                          suppressCartErrors();
                        }, 600);
                      }
                    });

                    observer.observe(cartDrawer, {
                      childList: true,
                      subtree: true
                    });
                  }

                  // Also listen for custom cart drawer events
                  document.addEventListener('cart-drawer:updated', function() {
                    setTimeout(function() {
                      initSubscriptionUpgrade();
                      suppressCartErrors();
                    }, 100);
                  });

                  // Listen for cart drawer opening
                  function initOnDrawerOpen() {
                    const drawer = document.querySelector('cart-drawer');
                    if (drawer) {
                      const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const isOpen = drawer.classList.contains('active') || drawer.classList.contains('is-open');
                            if (isOpen) {
                              setTimeout(function() {
                                initSubscriptionUpgrade();
                                suppressCartErrors();
                              }, 200);
                            }
                          }
                        });
                      });
                      observer.observe(drawer, { attributes: true });
                    }
                  }

                  // Initialize observer on load
                  if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                      observeCartDrawer();
                      initOnDrawerOpen();
                    });
                  } else {
                    observeCartDrawer();
                    initOnDrawerOpen();
                  }
                })();
              </script>

            {% when 'product_upsells' %}
              {% if block.settings.pin_above_footer == false %}
                {% if cart.item_count > 0 %}
                {%- liquid
                  assign products_list = block.settings.product_list
                  assign products_count = products_list.size
                  assign enable_slider = block.settings.enable_slider_mode
                -%}

                {%- if products_list == blank or products_count == 0 -%}
                  <div class="cart-upsell-empty-state" style="
                    padding: 32px 20px;
                    text-align: center;
                    background: #fafafa;
                    border-radius: 6px;
                    margin: 16px 14px;
                  " {{ block.shopify_attributes }}>
                    <p style="font-size: 13px; color: #999; margin: 0; font-weight: 500;">No cart upsell products added</p>
                  </div>
                {%- else -%}

                  {%- liquid
                    # Count visible upsells (not in cart and cart not empty)
                    assign visible_upsells_count = 0
                    if cart.item_count > 0
                      for product in products_list
                        assign is_in_cart = false
                        for item in cart.items
                          if item.product.id == product.id
                            assign is_in_cart = true
                            break
                          endif
                        endfor
                        unless is_in_cart
                          assign visible_upsells_count = visible_upsells_count | plus: 1
                        endunless
                      endfor
                    endif
                  -%}

                  {%- if visible_upsells_count > 0 -%}
                  {%- comment %} Outer wrapper with vertical padding for stacked mode {%- endcomment -%}
                  {%- unless enable_slider and products_count > 1 -%}
                    <div class="cart-upsell-outer-wrapper" style="
                      padding-top: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                      padding-bottom: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                    ">
                  {%- endunless -%}

                  {%- if block.settings.show_section_title and visible_upsells_count > 0 -%}
                    <style>
                      @media screen and (min-width: 750px) {
                        .upsell-section-title-{{ block.id }} h3 {
                          font-size: {{ block.settings.section_title_font_size_desktop | default: 18 }}px !important;
                        }
                      }
                    </style>
                    <div class="upsell-section-title upsell-section-title-{{ block.id }}" style="
                      text-align: {{ block.settings.section_title_alignment | default: 'left' }};
                      margin-bottom: {{ block.settings.section_title_margin_bottom | default: 12 }}px;
                      {% unless enable_slider and products_count > 1 %}
                      padding-left: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      padding-right: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      {% endunless %}
                    ">
                      {%- case block.settings.section_highlight_position -%}
                        {%- when 'inline_first' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'inline_middle' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'inline_last' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </h3>
                        {%- when 'above' -%}
                          <div style="margin-bottom: 8px;">
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </div>
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'below' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0 0 8px 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                          <div>
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </div>
                      {%- endcase -%}
                    </div>
                  {%- endif -%}

                  {%- comment %} Wrapper for slider or stacked mode {%- endcomment -%}
                  {%- if enable_slider and products_count > 1 -%}
                    {%- comment %} Slider mode {%- endcomment -%}
                    <div class="cart-upsell-slider-wrapper">
                      <div class="cart-upsell-slider-container">
                        <div class="cart-upsell-slider-track">
                  {%- else -%}
                    {%- comment %} Stacked mode with container padding and gap {%- endcomment -%}
                    <div class="cart-upsell-stacked-wrapper" style="
                      padding-left: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      padding-right: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      display: flex;
                      flex-direction: column;
                      gap: {{ block.settings.stacked_gap_between_upsells | default: 10 }}px;
                    ">
                  {%- endif -%}

                  {%- comment %} Render each product {%- endcomment -%}
                  {%- for product in products_list -%}
                    {% render 'upsell-block', block: block, type: 'cart-drawer', upsell_product: product %}
                  {%- endfor -%}

                  {%- comment %} Close wrapper {%- endcomment -%}
                  {%- if enable_slider and products_count > 1 -%}
                        </div>
                      </div>
                    </div>
                    <style>
                      .cart-upsell-slider-wrapper {
                        position: relative;
                        overflow: hidden;
                      }
                      .cart-upsell-slider-container {
                        overflow-x: scroll;
                        overflow-y: hidden;
                        -webkit-overflow-scrolling: touch;
                        scrollbar-width: thin;
                        scrollbar-color: {{ block.settings.scrollbar_thumb_color | default: '#888' }} {{ block.settings.scrollbar_track_color | default: '#f1f1f1' }};
                        padding-bottom: 1rem;
                        cursor: grab;
                      }
                      .cart-upsell-slider-container::-webkit-scrollbar {
                        height: {{ block.settings.scrollbar_height | default: 8 }}px;
                        background-color: {{ block.settings.scrollbar_track_color | default: '#f1f1f1' }};
                        border-radius: {{ block.settings.scrollbar_border_radius | default: 4 }}px;
                      }
                      .cart-upsell-slider-container::-webkit-scrollbar-thumb {
                        background-color: {{ block.settings.scrollbar_thumb_color | default: '#888' }};
                        border-radius: {{ block.settings.scrollbar_border_radius | default: 4 }}px;
                      }
                      .cart-upsell-slider-track {
                        display: flex;
                        gap: {{ block.settings.slider_gap | default: 16 }}px;
                        align-items: stretch;
                      }
                      .cart-upsell-slider-track .product-upsell-container {
                        width: {{ block.settings.slider_card_width_percent }}%;
                        flex-shrink: 0;
                        display: flex;
                      }
                      .cart-upsell-slider-track .upsell-wrapper {
                        flex: 1;
                      }
                      .cart-upsell-slider-track .upsell-title {
                        color: {{ block.settings.title_text_color | default: '#000000' }} !important;
                        font-size: {{ block.settings.title_font_size | default: 16 }}px !important;
                      }
                    </style>
                  {%- else -%}
                    </div>
                    {%- comment %} Close outer wrapper for stacked mode {%- endcomment -%}
                    </div>
                  {%- endif -%}

                  {%- endif -%}
                {%- endif -%}
                {% endif %}
              {% endif %}
            {% when 'gift' %}
              {% if block.settings.position == 'body' %}
                {% liquid
                  if block.settings.display == 'globally'
                    assign display = true
                  else 
                    assign display = false
                    assign handles_array = block.settings.display_product_handles | split: ','
                    if handles_array contains product.handle
                      assign display = true
                    endif
                  endif
                %}
                {% if display %}
                  {% render 'cart-gift', block: block, items_count: non_upsell_count %}
                {% endif %}
              {% endif %}
            {%- when 'text_with_icon' -%}
              {% if block.settings.position == 'body' %}
                {% render 'text-with-icon-block', block: block, margins: true, block_attributes: true %}
              {% endif %}
            {% when 'bundle_upsell' %}
              {%- comment -%} Only render in body if NOT pinned above footer {%- endcomment -%}
              {% unless block.settings.pin_above_footer %}
                {% render 'bundle-upsell', block: block, section: section %}
              {% endunless %}
            {% when 'image' %}
              {% if block.settings.position == 'body' %}
                <div 
                  class="product-info__image-block" 
                  style="--image-width:{{ block.settings.width }}%;--image-alignment:{{ block.settings.alignment }};--border-radius:{{ block.settings.border_radius | divided_by: 10.0 }}rem;--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;"
                  {{ block.shopify_attributes }} 
                >
                  {% if block.settings.image != blank %}
                    <div class="media media--transparent ratio" style="--ratio-percent: {{ 1 | divided_by: block.settings.image.aspect_ratio | times: 100 }}%">
                      {%- capture sizes -%}
                        (min-width: {% if section.settings.desktop_width == 'normal' %}430{% else %}580{% endif %}px) calc(370px * {{ block.settings.width | divided_by: 100 }}),
                        calc((100vw - {% if section.settings.mobile_width == 'partial' %}60{% else %}30{% endif %}px) * {{ block.settings.width | divided_by: 100 }})
                      {%- endcapture -%}
                      {{
                        block.settings.image
                        | image_url: width: 1500
                        | image_tag: loading: 'lazy', sizes: sizes, widths: '165, 360, 535, 750, 1070, 1250, 1500'
                      }}
                    </div>
                  {% else %}
                    {{ 'image' | placeholder_svg_tag: 'placeholder-svg placeholder' }}
                  {% endif %}
                </div>
              {% endif %}
            {%- when 'icon_with_text' -%}
              {% if block.settings.position == 'body' %}
                {% render 'icon-with-text',
                  block: block
                %}
              {% endif %}
            {%- when 'custom_liquid' -%}
              {% if block.settings.position == 'body' %}
                {{ block.settings.custom_liquid }}
              {% endif %}
            {% when 'urgency' %}
              {% if block.settings.position == 'body' %}
                <div class="cart-urgency color-{{ block.settings.color_scheme }}" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                  {{ block.settings.urgency }}
                </div>
              {% endif %}
            {% when 'guarantee_badge' %}
              {% if block.settings.position == 'body' %}
                <div
                  class="guarantee-badge"
                  style="
                    --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
                    --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
                    --font-size: {{ block.settings.font_size }}px;
                    --font-weight: {{ block.settings.font_weight }};
                    --text-color: {{ block.settings.text_color }};
                    --icon-color: {{ block.settings.icon_color }};
                    --icon-size: {{ block.settings.icon_size }}px;
                    --alignment: {{ block.settings.alignment }};
                  "
                  {{ block.shopify_attributes }}
                >
                  <div class="guarantee-badge__content">
                    <span class="guarantee-badge__icon">
                      {% case block.settings.icon_type %}
                        {% when 'badge' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                          </svg>
                        {% when 'shield' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM10 17L6 13L7.41 11.59L10 14.17L16.59 7.58L18 9L10 17Z"/>
                          </svg>
                        {% when 'check' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                          </svg>
                        {% when 'star' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                          </svg>
                        {% when 'custom' %}
                          {% if block.settings.custom_svg != blank %}
                            {{ block.settings.custom_svg }}
                          {% endif %}
                      {% endcase %}
                    </span>
                    <span class="guarantee-badge__text">{{ block.settings.badge_text }}</span>
                  </div>
                </div>
              {% endif %}
            {% when 'social_proof' %}
              {% if block.settings.position == 'body' %}
                <div
                  class="social-proof-bar{% if block.settings.full_width %} social-proof-bar--full-width{% endif %}{% if block.settings.enable_background %} social-proof-bar--with-bg{% endif %}"
                  style="
                    --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
                    --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
                    --font-size: {{ block.settings.font_size }}px;
                    --font-weight: {{ block.settings.font_weight }};
                    --text-color: {{ block.settings.text_color }};
                    --icon-color: {{ block.settings.icon_color }};
                    --icon-size: {{ block.settings.icon_size }}px;
                    --alignment: {{ block.settings.alignment }};
                    {% if block.settings.enable_gradient %}
                    --bg-color: {{ block.settings.gradient_background }};
                    {% else %}
                    --bg-color: {{ block.settings.background_color }};
                    {% endif %}
                    --bg-opacity: {{ block.settings.bg_opacity | default: 100 | divided_by: 100.0 }};
                    --backdrop-blur: {{ block.settings.backdrop_blur | default: 0 }}px;
                    --padding-vertical: {{ block.settings.padding_vertical }}px;
                    --border-radius: {{ block.settings.border_radius }}px;
                  "
                  {{ block.shopify_attributes }}
                >
                  <div class="social-proof-bar__content">
                    <span class="social-proof-bar__icon">
                      {% case block.settings.icon_type %}
                        {% when 'star' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                          </svg>
                        {% when 'users' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                          </svg>
                        {% when 'lock' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                          </svg>
                        {% when 'heart' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                          </svg>
                        {% when 'trophy' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 0c0 1.3-.84 2.4-2 2.82V7h2v1z"/>
                          </svg>
                        {% when 'verified' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.35z"/>
                          </svg>
                        {% when 'thumbs_up' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
                          </svg>
                        {% when 'custom' %}
                          {% if block.settings.custom_svg != blank %}
                            {{ block.settings.custom_svg }}
                          {% endif %}
                      {% endcase %}
                    </span>
                    <span class="social-proof-bar__text">{{ block.settings.text }}</span>
                  </div>
                </div>
              {% endif %}
            {% when 'video' %}
              {% if block.settings.position == 'body' %}
                {% render 'video-player', block: block %}
              {% endif %}
            {% when 'divider' %}
              {% if block.settings.position == 'body' %}
                <hr class="cart-divider" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
              {% endif %}
            {% when 'emoji_benefits' %}
              {% if block.settings.position == 'body' %}
                <div class="cart-emoji-benefits" {{ block.shopify_attributes }}>
                  {% if block.settings.benefit_1 != blank %}
                    <div class="benefit-item">{{ block.settings.emoji_1 }} {{ block.settings.benefit_1 }}</div>
                  {% endif %}
                  {% if block.settings.benefit_2 != blank %}
                    <div class="benefit-item">{{ block.settings.emoji_2 }} {{ block.settings.benefit_2 }}</div>
                  {% endif %}
                  {% if block.settings.benefit_3 != blank %}
                    <div class="benefit-item">{{ block.settings.emoji_3 }} {{ block.settings.benefit_3 }}</div>
                  {% endif %}
                </div>
              {% endif %}
            {% when 'cart_product_highlights' %}
              {% if block.settings.position == 'body' %}
                {% render 'product-flag', block: block %}
              {% endif %}
            {% when 'bundle_offer' %}
              {% if block.settings.position == 'body' %}
                {% render 'bundle-offer', block: block %}
              {% endif %}
            {% when 'estimated_shipping' %}
              {% if block.settings.position == 'body' %}
                {% render 'estimated-shipping', block: block %}
              {% endif %}
            {% when 'shipping_checkpoints' %}
              {% if block.settings.position == 'body' %}
                {% render 'shipping-checkpoints', block: block %}
              {% endif %}
            {% when 'button' %}
              {% if block.settings.position == 'body' %}
                {% render 'block-button', block: block %}
              {% endif %}
            {% when 'custom_html' %}
              {% if block.settings.position == 'body' %}
                <div class="custom-html-block custom-html-block--body"
                     style="--margin-top: {{ block.settings.margin_top | default: 16 }}px;
                            --margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                            --padding-horizontal: {{ block.settings.padding_horizontal | default: 16 }}px;"
                     {{ block.shopify_attributes }}>
                  {{ block.settings.html_content }}
                </div>
              {% endif %}
          {% endcase %}
        {% endfor %}
      </div>

      <!-- Pinned upsells above footer -->
      {% for block in section.blocks %}
        {% if block.type == 'product_upsells' and block.settings.pin_above_footer %}
          {% if cart.item_count > 0 %}
          {%- liquid
            assign products_list = block.settings.product_list
            assign products_count = products_list.size
            assign enable_slider = block.settings.enable_slider_mode
          -%}

          {%- if products_list == blank or products_count == 0 -%}
            <div class="cart-upsell-empty-state" style="
              padding: 32px 20px;
              text-align: center;
              background: #fafafa;
              border-radius: 6px;
              margin: 16px 14px;
            " {{ block.shopify_attributes }}>
              <p style="font-size: 13px; color: #999; margin: 0; font-weight: 500;">No cart upsell products added</p>
            </div>
          {%- else -%}

            {%- liquid
              # Count visible upsells (not in cart and cart not empty)
              assign visible_upsells_count = 0
              if cart.item_count > 0
                for product in products_list
                  assign is_in_cart = false
                  for item in cart.items
                    if item.product.id == product.id
                      assign is_in_cart = true
                      break
                    endif
                  endfor
                  unless is_in_cart
                    assign visible_upsells_count = visible_upsells_count | plus: 1
                  endunless
                endfor
              endif
            -%}

            {%- if visible_upsells_count > 0 -%}
            <div class="cart-drawer__pinned-upsells">
              {%- if block.settings.show_section_title -%}
                <div class="upsell-section-title" style="
                  text-align: {{ block.settings.section_title_alignment | default: 'left' }};
                  margin-bottom: {{ block.settings.section_title_margin_bottom | default: 12 }}px;
                  padding: 0 1.5rem;
                ">
                  {%- case block.settings.section_highlight_position -%}
                    {%- when 'inline_first' -%}
                      <h3 style="
                        font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                        font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                        color: {{ block.settings.section_title_color | default: '#000000' }};
                        margin: 0;
                      ">
                        <span class="highlight-text" style="
                          font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                          font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                          {% if block.settings.use_theme_highlight_colors %}
                            color: var(--color-accent, #ff6b6b);
                          {% else %}
                            {% if block.settings.section_highlight_gradient_enabled %}
                              background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                              -webkit-background-clip: text;
                              -webkit-text-fill-color: transparent;
                              background-clip: text;
                            {% else %}
                              color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                            {% endif %}
                          {% endif %}
                        ">{{ block.settings.section_highlighted_text }}</span>
                        {{ block.settings.section_title_before }}
                        {{ block.settings.section_title_after }}
                      </h3>
                    {%- when 'inline_middle' -%}
                      <h3 style="
                        font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                        font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                        color: {{ block.settings.section_title_color | default: '#000000' }};
                        margin: 0;
                      ">
                        {{ block.settings.section_title_before }}
                        <span class="highlight-text" style="
                          font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                          font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                          {% if block.settings.use_theme_highlight_colors %}
                            color: var(--color-accent, #ff6b6b);
                          {% else %}
                            {% if block.settings.section_highlight_gradient_enabled %}
                              background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                              -webkit-background-clip: text;
                              -webkit-text-fill-color: transparent;
                              background-clip: text;
                            {% else %}
                              color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                            {% endif %}
                          {% endif %}
                        ">{{ block.settings.section_highlighted_text }}</span>
                        {{ block.settings.section_title_after }}
                      </h3>
                    {%- when 'inline_last' -%}
                      <h3 style="
                        font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                        font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                        color: {{ block.settings.section_title_color | default: '#000000' }};
                        margin: 0;
                      ">
                        {{ block.settings.section_title_before }}
                        {{ block.settings.section_title_after }}
                        <span class="highlight-text" style="
                          font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                          font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                          {% if block.settings.use_theme_highlight_colors %}
                            color: var(--color-accent, #ff6b6b);
                          {% else %}
                            {% if block.settings.section_highlight_gradient_enabled %}
                              background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                              -webkit-background-clip: text;
                              -webkit-text-fill-color: transparent;
                              background-clip: text;
                            {% else %}
                              color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                            {% endif %}
                          {% endif %}
                        ">{{ block.settings.section_highlighted_text }}</span>
                      </h3>
                    {%- when 'above' -%}
                      <div style="margin-bottom: 8px;">
                        <span class="highlight-text" style="
                          font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                          font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                          {% if block.settings.use_theme_highlight_colors %}
                            color: var(--color-accent, #ff6b6b);
                          {% else %}
                            {% if block.settings.section_highlight_gradient_enabled %}
                              background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                              -webkit-background-clip: text;
                              -webkit-text-fill-color: transparent;
                              background-clip: text;
                            {% else %}
                              color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                            {% endif %}
                          {% endif %}
                        ">{{ block.settings.section_highlighted_text }}</span>
                      </div>
                      <h3 style="
                        font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                        font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                        color: {{ block.settings.section_title_color | default: '#000000' }};
                        margin: 0;
                      ">
                        {{ block.settings.section_title_before }}
                        {{ block.settings.section_title_after }}
                      </h3>
                    {%- when 'below' -%}
                      <h3 style="
                        font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                        font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                        color: {{ block.settings.section_title_color | default: '#000000' }};
                        margin: 0 0 8px 0;
                      ">
                        {{ block.settings.section_title_before }}
                        {{ block.settings.section_title_after }}
                      </h3>
                      <div>
                        <span class="highlight-text" style="
                          font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                          font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                          {% if block.settings.use_theme_highlight_colors %}
                            color: var(--color-accent, #ff6b6b);
                          {% else %}
                            {% if block.settings.section_highlight_gradient_enabled %}
                              background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                              -webkit-background-clip: text;
                              -webkit-text-fill-color: transparent;
                              background-clip: text;
                            {% else %}
                              color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                            {% endif %}
                          {% endif %}
                        ">{{ block.settings.section_highlighted_text }}</span>
                      </div>
                  {%- endcase -%}
                </div>
              {%- endif -%}
              {%- comment %} Wrapper for slider or stacked mode {%- endcomment -%}
              {%- if enable_slider and products_count > 1 -%}
                {%- comment %} Slider mode {%- endcomment -%}
                <div class="cart-upsell-slider-wrapper">
                  <div class="cart-upsell-slider-container">
                    <div class="cart-upsell-slider-track">
              {%- else -%}
                {%- comment %} Stacked mode with container padding and gap {%- endcomment -%}
                <div class="cart-upsell-stacked-wrapper" style="
                  padding-left: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                  padding-right: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                  padding-top: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                  padding-bottom: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                  display: flex;
                  flex-direction: column;
                  gap: {{ block.settings.stacked_gap_between_upsells | default: 10 }}px;
                ">
              {%- endif -%}

              {%- comment %} Render each product {%- endcomment -%}
              {%- for product in products_list -%}
                {% render 'upsell-block', block: block, type: 'cart-drawer', upsell_product: product %}
              {%- endfor -%}

              {%- comment %} Close wrapper {%- endcomment -%}
              {%- if enable_slider and products_count > 1 -%}
                    </div>
                  </div>
                </div>
                <style>
                  .cart-drawer__pinned-upsells {
                    padding: 1rem 0;
                    border-top: 1px solid rgba(0, 0, 0, 0.08);
                    background: var(--color-background, #fff);
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-wrapper {
                    position: relative;
                    overflow: hidden;
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-container {
                    overflow-x: scroll;
                    overflow-y: hidden;
                    -webkit-overflow-scrolling: touch;
                    scrollbar-width: thin;
                    scrollbar-color: {{ block.settings.scrollbar_thumb_color | default: '#888' }} {{ block.settings.scrollbar_track_color | default: '#f1f1f1' }};
                    padding-bottom: 1rem;
                    padding-left: 1.5rem;
                    padding-right: 1.5rem;
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-container::-webkit-scrollbar {
                    height: {{ block.settings.scrollbar_height | default: 8 }}px;
                    background-color: {{ block.settings.scrollbar_track_color | default: '#f1f1f1' }};
                    border-radius: {{ block.settings.scrollbar_border_radius | default: 4 }}px;
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-container::-webkit-scrollbar-thumb {
                    background-color: {{ block.settings.scrollbar_thumb_color | default: '#888' }};
                    border-radius: {{ block.settings.scrollbar_border_radius | default: 4 }}px;
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-track {
                    display: flex;
                    gap: {{ block.settings.slider_gap | default: 16 }}px;
                    align-items: stretch;
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-track .product-upsell-container {
                    width: {{ block.settings.slider_card_width_percent }}%;
                    flex-shrink: 0;
                    display: flex;
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-track .upsell-wrapper {
                    flex: 1;
                  }
                  .cart-drawer__pinned-upsells .cart-upsell-slider-track .upsell-title {
                    color: {{ block.settings.title_text_color | default: '#000000' }} !important;
                    font-size: {{ block.settings.title_font_size | default: 16 }}px !important;
                  }
                </style>
              {%- else -%}
                </div>
              {%- endif -%}
            </div>
            {%- endif -%}
          {%- endif -%}
          {% endif %}
        {% endif %}
      {% endfor %}

      <!-- Pinned bundle upsells above footer -->
      {% for block in section.blocks %}
        {% if block.type == 'bundle_upsell' and block.settings.pin_above_footer %}
          {% render 'bundle-upsell', block: block, section: section %}
        {% endif %}
      {% endfor %}

      <div class="drawer__footer">
        <div class="drawer__footer-scrollable">
        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'discount_field' %}
              {% render 'cart-discount-field', block: block %}
            {% when 'cart_note' %}
              <details id="Details-CartDrawer" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <summary>
                  <span class="summary__title">
                    {{ 'sections.cart.note' | t }}
                    {% render 'icon-caret' %}
                  </span>
                </summary>
                <cart-note class="cart__note field">
                  <label class="visually-hidden" for="CartDrawer-Note">{{ 'sections.cart.note' | t }}</label>
                  <textarea
                    id="CartDrawer-Note"
                    class="text-area text-area--resize-vertical field__input"
                    name="note"
                    placeholder="{{ 'sections.cart.note' | t }}"
                  >{{ cart.note }}</textarea>
                </cart-note>
              </details>
            {% when 'countdown_timer' %}
              {%- comment -%} Countdown timer in footer position now renders in second loop with payment badges, guarantee badge, etc. {%- endcomment -%}
            {% when 'delivery_date' %}
              {%- comment -%} Delivery date in footer position now renders in second loop with payment badges, guarantee badge, etc. {%- endcomment -%}
            {% when 'product_upsells' %}
              {% comment %} Skip - product upsells render in body/pinned section only {% endcomment %}
            {%- when 'product_upsells_OLD_FOOTER_VERSION' -%}
                {%- liquid
                  assign products_list = block.settings.product_list
                  assign products_count = products_list.size
                  assign enable_slider = block.settings.enable_slider_mode
                -%}

                {%- if products_list == blank or products_count == 0 -%}
                  <div class="cart-upsell-empty-state" style="
                    padding: 32px 20px;
                    text-align: center;
                    background: #fafafa;
                    border-radius: 6px;
                    margin: 16px 14px;
                  " {{ block.shopify_attributes }}>
                    <p style="font-size: 13px; color: #999; margin: 0; font-weight: 500;">No cart upsell products added</p>
                  </div>
                {%- else -%}

                  {%- liquid
                    # Count visible upsells (not in cart and cart not empty)
                    assign visible_upsells_count = 0
                    if cart.item_count > 0
                      for product in products_list
                        assign is_in_cart = false
                        for item in cart.items
                          if item.product.id == product.id
                            assign is_in_cart = true
                            break
                          endif
                        endfor
                        unless is_in_cart
                          assign visible_upsells_count = visible_upsells_count | plus: 1
                        endunless
                      endfor
                    endif
                  -%}

                  {%- if visible_upsells_count > 0 -%}

                  {%- comment %} Outer wrapper with vertical padding for stacked mode {%- endcomment -%}
                  {%- unless enable_slider and products_count > 1 -%}
                    <div class="cart-upsell-outer-wrapper" style="
                      padding-top: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                      padding-bottom: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                    ">
                  {%- endunless -%}

                  {%- if block.settings.show_section_title and visible_upsells_count > 0 -%}
                    <style>
                      @media screen and (min-width: 750px) {
                        .upsell-section-title-{{ block.id }} h3 {
                          font-size: {{ block.settings.section_title_font_size_desktop | default: 18 }}px !important;
                        }
                      }
                    </style>
                    <div class="upsell-section-title upsell-section-title-{{ block.id }}" style="
                      text-align: {{ block.settings.section_title_alignment | default: 'left' }};
                      margin-bottom: {{ block.settings.section_title_margin_bottom | default: 12 }}px;
                      {% unless enable_slider and products_count > 1 %}
                      padding-left: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      padding-right: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      {% endunless %}
                    ">
                      {%- case block.settings.section_highlight_position -%}
                        {%- when 'inline_first' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'inline_middle' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'inline_last' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </h3>
                        {%- when 'above' -%}
                          <div style="margin-bottom: 8px;">
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </div>
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'below' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0 0 8px 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                          <div>
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </div>
                      {%- endcase -%}
                    </div>
                  {%- endif -%}

                  {%- comment %} Wrapper for slider or stacked mode {%- endcomment -%}
                  {%- if enable_slider and products_count > 1 -%}
                    {%- comment %} Slider mode {%- endcomment -%}
                    <div class="cart-upsell-slider-wrapper">
                      <div class="cart-upsell-slider-container">
                        <div class="cart-upsell-slider-track">
                  {%- else -%}
                    {%- comment %} Stacked mode with container padding and gap {%- endcomment -%}
                    <div class="cart-upsell-stacked-wrapper" style="
                      padding-left: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      padding-right: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      display: flex;
                      flex-direction: column;
                      gap: {{ block.settings.stacked_gap_between_upsells | default: 10 }}px;
                    ">
                  {%- endif -%}

                  {%- comment %} Render each product {%- endcomment -%}
                  {%- for product in products_list -%}
                    {% render 'upsell-block', block: block, type: 'cart-drawer', upsell_product: product %}
                  {%- endfor -%}

                  {%- comment %} Close wrapper {%- endcomment -%}
                  {%- if enable_slider and products_count > 1 -%}
                        </div>
                      </div>
                    </div>
                    <style>
                      .cart-upsell-slider-wrapper {
                        position: relative;
                        overflow: hidden;
                      }
                      .cart-upsell-slider-container {
                        overflow-x: scroll;
                        overflow-y: hidden;
                        -webkit-overflow-scrolling: touch;
                        scrollbar-width: none;
                        -ms-overflow-style: none;
                      }
                      .cart-upsell-slider-container::-webkit-scrollbar {
                        display: none;
                      }
                      .cart-upsell-slider-track {
                        display: flex;
                        gap: {{ block.settings.slider_gap | default: 16 }}px;
                        align-items: stretch;
                        padding-left: {{ block.settings.slider_horizontal_padding | default: 14 }}px;
                        padding-right: {{ block.settings.slider_horizontal_padding | default: 14 }}px;
                      }
                      .cart-upsell-slider-track .product-upsell-container {
                        width: {{ block.settings.slider_card_width_percent | default: 85 }}%;
                        flex-shrink: 0;
                        display: flex;
                      }
                      .cart-upsell-slider-track .upsell-wrapper {
                        flex: 1;
                      }
                    </style>
                    <script>
                      (function() {
                        function initCartUpsellSlider() {
                          const sliderContainers = document.querySelectorAll('.cart-upsell-slider-container:not([data-slider-initialized])');

                          sliderContainers.forEach(container => {
                            container.setAttribute('data-slider-initialized', 'true');

                            let isDown = false;
                            let startX;
                            let scrollLeft;

                            container.addEventListener('mousedown', (e) => {
                              isDown = true;
                              container.style.cursor = 'grabbing';
                              startX = e.pageX - container.offsetLeft;
                              scrollLeft = container.scrollLeft;
                            });

                            container.addEventListener('mouseleave', () => {
                              isDown = false;
                              container.style.cursor = 'grab';
                            });

                            container.addEventListener('mouseup', () => {
                              isDown = false;
                              container.style.cursor = 'grab';
                            });

                            container.addEventListener('mousemove', (e) => {
                              if (!isDown) return;
                              e.preventDefault();
                              const x = e.pageX - container.offsetLeft;
                              const walk = (x - startX) * 2;
                              container.scrollLeft = scrollLeft - walk;
                            });

                            // Touch support
                            let touchStartX = 0;
                            let touchScrollLeft = 0;

                            container.addEventListener('touchstart', (e) => {
                              touchStartX = e.touches[0].pageX;
                              touchScrollLeft = container.scrollLeft;
                            }, { passive: true });

                            container.addEventListener('touchmove', (e) => {
                              const touchX = e.touches[0].pageX;
                              const walk = (touchStartX - touchX) * 1.5;
                              container.scrollLeft = touchScrollLeft + walk;
                            }, { passive: true });
                          });
                        }

                        // Initialize on DOM ready
                        if (document.readyState === 'loading') {
                          document.addEventListener('DOMContentLoaded', initCartUpsellSlider);
                        } else {
                          initCartUpsellSlider();
                        }

                        // Re-initialize on cart update and section load
                        document.addEventListener('shopify:section:load', initCartUpsellSlider);
                        document.addEventListener('cart:updated', initCartUpsellSlider);
                      })();
                    </script>
                  {%- else -%}
                    </div>
                  {%- endif -%}

                  {%- comment %} Close outer wrapper {%- endcomment -%}
                  {%- unless enable_slider and products_count > 1 -%}
                    </div>
                  {%- endunless -%}

                  {%- endif -%}
                {%- endif -%}
            {% when 'subtotals' %}
              {% comment %} Skip subtotals in first pass {% endcomment %}
            {% when 'checkout_btn' %}
              {% comment %} Skip checkout in first pass {% endcomment %}
            {%- when 'tnc_checkbox' -%}
              <div style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <style>
                  .tnc-chekcbox {
                    font-size: {{ block.settings.checkbox_text_size | divided_by: 10.0 }}rem;
                  }
                  .tnc-checkbox-warning {
                    font-size: {{ block.settings.warning_text_size | divided_by: 10.0 }}rem;
                    text-align: {{ block.settings.warning_alignment }};
                    color: {{ block.settings.warning_text_color }};
                  }
                </style>
                <tnc-chekcbox
                  class='tnc-chekcbox flex flex-align-center{% if block.settings.checkbox_alignment == 'center' %} center flex-justify-center{% endif %}'
                  data-checked="false"
                  data-disable-button="{{ block.settings.disable_checkout_button }}"
                  data-warning-text='{{ block.settings.warning_text }}'
                  data-warning-position='{{ block.settings.warning_position }}'
                >
                  <svg
                    class="checkmark-checked text-color-{{ block.settings.checkbox_color }} flex-shrink-0"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 448 512"
                    fill="currentColor"
                    width="50"
                    height="50"
                  >
                    <path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM337 209L209 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L303 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                  </svg>
                  <svg
                    class="checkmark-unchecked text-color-{{ block.settings.checkbox_color }} flex-shrink-0"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 448 512"
                    fill="currentColor"
                    width="50"
                    height="50"
                  >
                    <path d="M384 80c8.8 0 16 7.2 16 16V416c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16H384zM64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64z"/>
                  </svg>
                  <p class="tnc-checkbox__text margin-0">
                    {{ block.settings.checkbox_text }}
                  </p>
                </tnc-chekcbox>
                <div class='tnc-checkbox-warning tnc-checkbox-warning--under-checkbox hidden' style='margin-top: 0.4em;'></div>
              </div>
            {% when 'product_upsells' %}
              {% comment %} Skip - product upsells render in body/pinned section only {% endcomment %}
            {%- when 'product_upsells_OLD_FOOTER_VERSION' -%}
                {%- liquid
                  assign products_list = block.settings.product_list
                  assign products_count = products_list.size
                  assign enable_slider = block.settings.enable_slider_mode
                -%}

                {%- if products_list == blank or products_count == 0 -%}
                  <div class="cart-upsell-empty-state" style="
                    padding: 32px 20px;
                    text-align: center;
                    background: #fafafa;
                    border-radius: 6px;
                    margin: 16px 14px;
                  " {{ block.shopify_attributes }}>
                    <p style="font-size: 13px; color: #999; margin: 0; font-weight: 500;">No cart upsell products added</p>
                  </div>
                {%- else -%}

                  {%- liquid
                    # Count visible upsells (not in cart and cart not empty)
                    assign visible_upsells_count = 0
                    if cart.item_count > 0
                      for product in products_list
                        assign is_in_cart = false
                        for item in cart.items
                          if item.product.id == product.id
                            assign is_in_cart = true
                            break
                          endif
                        endfor
                        unless is_in_cart
                          assign visible_upsells_count = visible_upsells_count | plus: 1
                        endunless
                      endfor
                    endif
                  -%}

                  {%- if visible_upsells_count > 0 -%}

                  {%- comment %} Outer wrapper with vertical padding for stacked mode {%- endcomment -%}
                  {%- unless enable_slider and products_count > 1 -%}
                    <div class="cart-upsell-outer-wrapper" style="
                      padding-top: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                      padding-bottom: {{ block.settings.stacked_container_padding_vertical | default: 0 }}px;
                    ">
                  {%- endunless -%}

                  {%- if block.settings.show_section_title and visible_upsells_count > 0 -%}
                    <style>
                      @media screen and (min-width: 750px) {
                        .upsell-section-title-{{ block.id }} h3 {
                          font-size: {{ block.settings.section_title_font_size_desktop | default: 18 }}px !important;
                        }
                      }
                    </style>
                    <div class="upsell-section-title upsell-section-title-{{ block.id }}" style="
                      text-align: {{ block.settings.section_title_alignment | default: 'left' }};
                      margin-bottom: {{ block.settings.section_title_margin_bottom | default: 12 }}px;
                      {% unless enable_slider and products_count > 1 %}
                      padding-left: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      padding-right: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      {% endunless %}
                    ">
                      {%- case block.settings.section_highlight_position -%}
                        {%- when 'inline_first' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'inline_middle' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'inline_last' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </h3>
                        {%- when 'above' -%}
                          <div style="margin-bottom: 8px;">
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </div>
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                        {%- when 'below' -%}
                          <h3 style="
                            font-size: {{ block.settings.section_title_font_size_mobile | default: 18 }}px;
                            font-weight: {{ block.settings.section_title_font_weight | default: 700 }};
                            color: {{ block.settings.section_title_color | default: '#000000' }};
                            margin: 0 0 8px 0;
                          ">
                            {{ block.settings.section_title_before }}
                            {{ block.settings.section_title_after }}
                          </h3>
                          <div>
                            <span class="highlight-text" style="
                              font-size: {{ block.settings.section_highlight_font_size | default: 18 }}px;
                              font-weight: {{ block.settings.section_highlight_font_weight | default: 700 }};
                              {% if block.settings.use_theme_highlight_colors %}
                                color: var(--color-accent, #ff6b6b);
                              {% else %}
                                {% if block.settings.section_highlight_gradient_enabled %}
                                  background: {{ block.settings.section_highlight_gradient | default: 'linear-gradient(90deg, rgba(237, 18, 45, 1), rgba(255, 107, 107, 1) 100%)' }};
                                  -webkit-background-clip: text;
                                  -webkit-text-fill-color: transparent;
                                  background-clip: text;
                                {% else %}
                                  color: {{ block.settings.section_highlight_color | default: '#ed122d' }};
                                {% endif %}
                              {% endif %}
                            ">{{ block.settings.section_highlighted_text }}</span>
                          </div>
                      {%- endcase -%}
                    </div>
                  {%- endif -%}

                  {%- comment %} Wrapper for slider or stacked mode {%- endcomment -%}
                  {%- if enable_slider and products_count > 1 -%}
                    {%- comment %} Slider mode {%- endcomment -%}
                    <div class="cart-upsell-slider-wrapper">
                      <div class="cart-upsell-slider-container">
                        <div class="cart-upsell-slider-track">
                  {%- else -%}
                    {%- comment %} Stacked mode with container padding and gap {%- endcomment -%}
                    <div class="cart-upsell-stacked-wrapper" style="
                      padding-left: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      padding-right: {{ block.settings.stacked_container_padding_horizontal | default: 14 }}px;
                      display: flex;
                      flex-direction: column;
                      gap: {{ block.settings.stacked_gap_between_upsells | default: 10 }}px;
                    ">
                  {%- endif -%}

                  {%- comment %} Render each product {%- endcomment -%}
                  {%- for product in products_list -%}
                    {% render 'upsell-block', block: block, type: 'cart-drawer', upsell_product: product %}
                  {%- endfor -%}

                  {%- comment %} Close wrapper {%- endcomment -%}
                  {%- if enable_slider and products_count > 1 -%}
                        </div>
                      </div>
                    </div>
                    <style>
                      .cart-upsell-slider-wrapper {
                        position: relative;
                        overflow: hidden;
                      }
                      .cart-upsell-slider-container {
                        overflow-x: scroll;
                        overflow-y: hidden;
                        -webkit-overflow-scrolling: touch;
                        scrollbar-width: none;
                        -ms-overflow-style: none;
                      }
                      .cart-upsell-slider-container::-webkit-scrollbar {
                        display: none;
                      }
                      .cart-upsell-slider-track {
                        display: flex;
                        gap: {{ block.settings.slider_gap | default: 16 }}px;
                        align-items: stretch;
                        padding-left: {{ block.settings.slider_horizontal_padding | default: 14 }}px;
                        padding-right: {{ block.settings.slider_horizontal_padding | default: 14 }}px;
                      }
                      .cart-upsell-slider-track .product-upsell-container {
                        width: {{ block.settings.slider_card_width_percent | default: 85 }}%;
                        flex-shrink: 0;
                        display: flex;
                      }
                      .cart-upsell-slider-track .upsell-wrapper {
                        flex: 1;
                      }
                    </style>
                    <script>
                      (function() {
                        function initCartUpsellSlider() {
                          const sliderContainers = document.querySelectorAll('.cart-upsell-slider-container:not([data-slider-initialized])');

                          sliderContainers.forEach(container => {
                            container.setAttribute('data-slider-initialized', 'true');

                            let isDown = false;
                            let startX;
                            let scrollLeft;

                            container.addEventListener('mousedown', (e) => {
                              isDown = true;
                              container.style.cursor = 'grabbing';
                              startX = e.pageX - container.offsetLeft;
                              scrollLeft = container.scrollLeft;
                            });

                            container.addEventListener('mouseleave', () => {
                              isDown = false;
                              container.style.cursor = 'grab';
                            });

                            container.addEventListener('mouseup', () => {
                              isDown = false;
                              container.style.cursor = 'grab';
                            });

                            container.addEventListener('mousemove', (e) => {
                              if (!isDown) return;
                              e.preventDefault();
                              const x = e.pageX - container.offsetLeft;
                              const walk = (x - startX) * 2;
                              container.scrollLeft = scrollLeft - walk;
                            });

                            // Touch support
                            let touchStartX = 0;
                            let touchScrollLeft = 0;

                            container.addEventListener('touchstart', (e) => {
                              touchStartX = e.touches[0].pageX;
                              touchScrollLeft = container.scrollLeft;
                            }, { passive: true });

                            container.addEventListener('touchmove', (e) => {
                              const touchX = e.touches[0].pageX;
                              const walk = (touchStartX - touchX) * 1.5;
                              container.scrollLeft = touchScrollLeft + walk;
                            }, { passive: true });
                          });
                        }

                        // Initialize on DOM ready
                        if (document.readyState === 'loading') {
                          document.addEventListener('DOMContentLoaded', initCartUpsellSlider);
                        } else {
                          initCartUpsellSlider();
                        }

                        // Re-initialize on cart update and section load
                        document.addEventListener('shopify:section:load', initCartUpsellSlider);
                        document.addEventListener('cart:updated', initCartUpsellSlider);
                      })();
                    </script>
                  {%- else -%}
                    </div>
                  {%- endif -%}

                  {%- comment %} Close outer wrapper {%- endcomment -%}
                  {%- unless enable_slider and products_count > 1 -%}
                    </div>
                  {%- endunless -%}

                  {%- endif -%}
                {%- endif -%}
            {%- when 'text_with_icon' -%}
              {% if block.settings.position == 'footer' %}
                {% render 'text-with-icon-block', block: block, margins: true, block_attributes: true %}
              {% endif %}
            {% when 'image' %}
              {% if block.settings.position == 'footer' %}
                <div 
                  class="product-info__image-block" 
                  style="--image-width:{{ block.settings.width }}%;--image-alignment:{{ block.settings.alignment }};--border-radius:{{ block.settings.border_radius | divided_by: 10.0 }}rem;--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;"
                  {{ block.shopify_attributes }} 
                >
                  {% if block.settings.image != blank %}
                    <div class="media media--transparent ratio" style="--ratio-percent: {{ 1 | divided_by: block.settings.image.aspect_ratio | times: 100 }}%">
                      {%- capture sizes -%}
                        (min-width: {% if section.settings.desktop_width == 'normal' %}430{% else %}580{% endif %}px) calc(370px * {{ block.settings.width | divided_by: 100 }}),
                        calc((100vw - {% if section.settings.mobile_width == 'partial' %}60{% else %}30{% endif %}px) * {{ block.settings.width | divided_by: 100 }})
                      {%- endcapture -%}
                      {{
                        block.settings.image
                        | image_url: width: 1500
                        | image_tag: loading: 'lazy', sizes: sizes, widths: '165, 360, 535, 750, 1070, 1250, 1500'
                      }}
                    </div>
                  {% else %}
                    {{ 'image' | placeholder_svg_tag: 'placeholder-svg placeholder' }}
                  {% endif %}
                </div>
              {% endif %}
            {%- when 'icon_with_text' -%}
              {% if block.settings.position == 'footer' %}
                {% render 'icon-with-text',
                  block: block
                %}
              {% endif %}
            {%- when 'custom_liquid' -%}
              {% if block.settings.position == 'footer' %}
                {{ block.settings.custom_liquid }}
              {% endif %}
            {% when 'urgency' %}
              {% if block.settings.position == 'footer' %}
                <div class="cart-urgency color-{{ block.settings.color_scheme }}" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                  {{ block.settings.urgency }}
                </div>
              {% endif %}
            {% when 'video' %}
              {% if block.settings.position == 'footer' %}
                {% render 'video-player', block: block %}
              {% endif %}
            {% when 'divider' %}
              {% if block.settings.position == 'footer' %}
                <hr class="cart-divider" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
              {% endif %}
            {% when 'emoji_benefits' %}
              {% if block.settings.position == 'footer' %}
                <div class="cart-emoji-benefits" {{ block.shopify_attributes }}>
                  {% if block.settings.benefit_1 != blank %}
                    <div class="benefit-item">{{ block.settings.emoji_1 }} {{ block.settings.benefit_1 }}</div>
                  {% endif %}
                  {% if block.settings.benefit_2 != blank %}
                    <div class="benefit-item">{{ block.settings.emoji_2 }} {{ block.settings.benefit_2 }}</div>
                  {% endif %}
                  {% if block.settings.benefit_3 != blank %}
                    <div class="benefit-item">{{ block.settings.emoji_3 }} {{ block.settings.benefit_3 }}</div>
                  {% endif %}
                </div>
              {% endif %}
            {% when 'cart_product_highlights' %}
              {%- comment -%} Product Highlights in footer position now renders in second loop with payment badges, guarantee badge, etc. {%- endcomment -%}
            {% when 'bundle_offer' %}
              {% if block.settings.position == 'footer' %}
                {% render 'bundle-offer', block: block %}
              {% endif %}
            {% when 'estimated_shipping' %}
              {% if block.settings.position == 'footer' %}
                {% render 'estimated-shipping', block: block %}
              {% endif %}
            {% when 'shipping_checkpoints' %}
              {% if block.settings.position == 'footer' %}
                {% render 'shipping-checkpoints', block: block %}
              {% endif %}
            {% when 'button' %}
              {% if block.settings.position == 'footer' %}
                {% render 'block-button', block: block %}
              {% endif %}
          {% endcase %}
        {% endfor %}
        </div>

        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'subtotals' %}
              <div class="cart-drawer__footer" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <div class="cart-drawer__totals" role="status">
                  {% if block.settings.display_subtotal %}
                    {% capture subtotal_money %}<span class='cart-drawer__totals__row__money'>{{ cart.total_price | money }}</span>{% endcapture %}
                    <p class='cart-drawer__totals__row cart-drawer__totals__row--{{ block.settings.subtotal_alignment }} text-color-{{ block.settings.subtotal_text_color }}' style='--text-size:{{ block.settings.subtotal_text_size | divided_by: 10.0 }}rem;'>
                      <span>{{ block.settings.subtotal_left_text | replace: '[subtotal]', subtotal_money }}</span><span>{{ block.settings.subtotal_right_text | replace: '[subtotal]', subtotal_money }}</span>
                    </p>
                  {% endif %}
                </div>
                {%- if block.settings.display_discounts and cart.cart_level_discount_applications.size > 0 -%}
                  <div class="cart-drawer__discounts cart-drawer__footer__discounts list-unstyled" style='--alignment:{{ block.settings.discounts_alignment }};' role="list" aria-label="{{ 'customer.order.discount' | t }}">
                    <span class='cart-drawer__discounts__label'>{{ block.settings.discounts_label }}</span>
                    {%- for discount in cart.cart_level_discount_applications -%}
                      <div class="badge">
                        {%- render 'icon-discount' -%}
                        <span>{{ discount.title }} (-{{ discount.total_allocated_amount | money }})</span>
                      </div>
                    {%- endfor -%}
                  </div>
                {%- endif -%}
              </div>
            {% when 'guarantee_badge' %}
              {% if block.settings.position == 'footer' %}
                <div
                  class="guarantee-badge"
                  style="
                    --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
                    --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
                    --font-size: {{ block.settings.font_size }}px;
                    --font-weight: {{ block.settings.font_weight }};
                    --text-color: {{ block.settings.text_color }};
                    --icon-color: {{ block.settings.icon_color }};
                    --icon-size: {{ block.settings.icon_size }}px;
                    --alignment: {{ block.settings.alignment }};
                  "
                  {{ block.shopify_attributes }}
                >
                  <div class="guarantee-badge__content">
                    <span class="guarantee-badge__icon">
                      {% case block.settings.icon_type %}
                        {% when 'badge' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                          </svg>
                        {% when 'shield' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1ZM10 17L6 13L7.41 11.59L10 14.17L16.59 7.58L18 9L10 17Z"/>
                          </svg>
                        {% when 'check' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                          </svg>
                        {% when 'star' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                          </svg>
                        {% when 'custom' %}
                          {% if block.settings.custom_svg != blank %}
                            {{ block.settings.custom_svg }}
                          {% endif %}
                      {% endcase %}
                    </span>
                    <span class="guarantee-badge__text">{{ block.settings.badge_text }}</span>
                  </div>
                </div>
              {% endif %}
            {% when 'social_proof' %}
              {% if block.settings.position == 'footer' %}
                <div
                  class="social-proof-bar{% if block.settings.full_width %} social-proof-bar--full-width{% endif %}{% if block.settings.enable_background %} social-proof-bar--with-bg{% endif %}"
                  style="
                    --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
                    --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
                    --font-size: {{ block.settings.font_size }}px;
                    --font-weight: {{ block.settings.font_weight }};
                    --text-color: {{ block.settings.text_color }};
                    --icon-color: {{ block.settings.icon_color }};
                    --icon-size: {{ block.settings.icon_size }}px;
                    --alignment: {{ block.settings.alignment }};
                    {% if block.settings.enable_gradient %}
                    --bg-color: {{ block.settings.gradient_background }};
                    {% else %}
                    --bg-color: {{ block.settings.background_color }};
                    {% endif %}
                    --bg-opacity: {{ block.settings.bg_opacity | default: 100 | divided_by: 100.0 }};
                    --backdrop-blur: {{ block.settings.backdrop_blur | default: 0 }}px;
                    --padding-vertical: {{ block.settings.padding_vertical }}px;
                    --border-radius: {{ block.settings.border_radius }}px;
                  "
                  {{ block.shopify_attributes }}
                >
                  <div class="social-proof-bar__content">
                    <span class="social-proof-bar__icon">
                      {% case block.settings.icon_type %}
                        {% when 'star' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                          </svg>
                        {% when 'users' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                          </svg>
                        {% when 'lock' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                          </svg>
                        {% when 'heart' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                          </svg>
                        {% when 'trophy' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 0c0 1.3-.84 2.4-2 2.82V7h2v1z"/>
                          </svg>
                        {% when 'verified' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.35z"/>
                          </svg>
                        {% when 'thumbs_up' %}
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
                          </svg>
                        {% when 'custom' %}
                          {% if block.settings.custom_svg != blank %}
                            {{ block.settings.custom_svg }}
                          {% endif %}
                      {% endcase %}
                    </span>
                    <span class="social-proof-bar__text">{{ block.settings.text }}</span>
                  </div>
                </div>
              {% endif %}
            {% when 'checkout_btn' %}
              <style>
                #CartDrawer-Checkout {
                  --checkout-icon-size: {{ block.settings.button_icon_size | default: 20 }}px;
                  --checkout-icon-color: {{ block.settings.button_icon_color | default: '#ffffff' }};
                  --checkout-icon-gap: {{ block.settings.button_icon_gap | default: 8 }}px;
                  --checkout-icon-margin-bottom: {{ block.settings.button_icon_margin_bottom | default: 0 }}px;
                  display: flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                  gap: var(--checkout-icon-gap, 8px) !important;
                  padding: {{ block.settings.button_padding_vertical | default: 12 }}px {{ block.settings.button_padding_horizontal | default: 24 }}px !important;
                  font-size: {{ block.settings.button_font_size | default: 14 }}px !important;
                  font-weight: {{ block.settings.button_font_weight | default: '600' }} !important;
                  {% if block.settings.override_theme_styles %}
                    border: {{ block.settings.button_border_width | default: 0 }}px solid {{ block.settings.button_border_color | default: '#000000' }} !important;
                    border-radius: {{ block.settings.button_border_radius | default: 4 }}px !important;
                    {% if block.settings.enable_gradient %}
                      background: {{ block.settings.button_gradient | default: 'linear-gradient(180deg, rgba(255, 87, 34, 1), rgba(255, 87, 34, 1))' }} !important;
                    {% elsif block.settings.enable_custom_color %}
                      background-color: {{ block.settings.custom_color }} !important;
                      background: {{ block.settings.custom_color }} !important;
                      --color-button: {{ block.settings.custom_color.red }}, {{ block.settings.custom_color.green }}, {{ block.settings.custom_color.blue }};
                    {% endif %}
                  {% endif %}
                }

                #CartDrawer-Checkout > * {
                  display: inline-flex;
                  align-items: center;
                  vertical-align: middle;
                }

                #CartDrawer-Checkout .material-icon {
                  font-size: var(--checkout-icon-size, 20px) !important;
                  color: var(--checkout-icon-color, #ffffff) !important;
                  width: var(--checkout-icon-size, 20px) !important;
                  height: var(--checkout-icon-size, 20px) !important;
                  max-height: var(--checkout-icon-size, 20px) !important;
                  display: inline-flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                  flex-shrink: 0 !important;
                  line-height: 1 !important;
                  vertical-align: middle !important;
                  margin: 0 0 var(--checkout-icon-margin-bottom, 0px) 0 !important;
                }

                #CartDrawer-Checkout .checkout-button__icon-svg {
                  display: inline-flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                  width: var(--checkout-icon-size, 20px) !important;
                  height: var(--checkout-icon-size, 20px) !important;
                  max-height: var(--checkout-icon-size, 20px) !important;
                  flex-shrink: 0 !important;
                  line-height: 1 !important;
                  vertical-align: middle !important;
                  margin: 0 0 var(--checkout-icon-margin-bottom, 0px) 0 !important;
                }

                #CartDrawer-Checkout .checkout-button__icon-svg svg {
                  width: var(--checkout-icon-size, 20px) !important;
                  height: var(--checkout-icon-size, 20px) !important;
                  max-height: var(--checkout-icon-size, 20px) !important;
                  fill: var(--checkout-icon-color, #ffffff) !important;
                  color: var(--checkout-icon-color, #ffffff) !important;
                  display: block !important;
                  vertical-align: middle !important;
                }

                #CartDrawer-Checkout .checkout-button__icon-svg svg path,
                #CartDrawer-Checkout .checkout-button__icon-svg svg circle,
                #CartDrawer-Checkout .checkout-button__icon-svg svg rect,
                #CartDrawer-Checkout .checkout-button__icon-svg svg polygon {
                  fill: inherit;
                }

                #CartDrawer-Checkout .button__label {
                  display: inline-flex !important;
                  align-items: center !important;
                  line-height: 1.2 !important;
                  vertical-align: middle !important;
                  margin: 0 !important;
                }

                /* Override inherit rule for button prices */
                #CartDrawer-Checkout .checkout-button__price {
                  {% if block.settings.price_color != blank %}
                  color: {{ block.settings.price_color }} !important;
                  {% endif %}
                  font-size: {{ block.settings.price_font_size | default: 16 }}px !important;
                  font-weight: {{ block.settings.price_font_weight | default: 600 }} !important;
                }

                #CartDrawer-Checkout .checkout-button__compare-price {
                  {% if block.settings.compare_price_color != blank %}
                  color: {{ block.settings.compare_price_color }} !important;
                  {% endif %}
                  font-size: {{ block.settings.compare_price_font_size | default: 14 }}px !important;
                  font-weight: {{ block.settings.compare_price_font_weight | default: 400 }} !important;
                }
              </style>
              <div class="cart__ctas" style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;" {{ block.shopify_attributes }}>
                <noscript>
                  <button type="submit" class="cart__update-button button button--secondary" form="CartDrawer-Form">
                    {{ 'sections.cart.update' | t }}
                  </button>
                </noscript>
                <div class='tnc-checkbox-warning tnc-checkbox-warning--above-button hidden' style='margin-bottom: 0.6em;'></div>
                <button
                  type="submit"
                  id="CartDrawer-Checkout"
                  class="cart__checkout-button button"
                  name="checkout"
                  form="CartDrawer-Form"
                  {% if cart == empty %}
                    disabled
                  {% endif %}
                >
                  {% if block.settings.button_icon_position == 'before' %}
                    {% if block.settings.button_custom_icon != blank %}
                      <span class="checkout-button__icon-svg">
                        {{ block.settings.button_custom_icon }}
                      </span>
                    {% elsif block.settings.button_icon != blank %}
                      {% render 'material-icon', icon: block.settings.button_icon, filled: block.settings.button_icon_filled %}
                    {% endif %}
                  {% endif %}
                  <span class='button__label'>
                    {{ block.settings.button_text | default: 'Checkout' }}
                    {% if block.settings.display_price %}
                      {% assign separator = block.settings.price_separator | default: '-' %}
                      {% assign separator_gap = block.settings.separator_gap | default: 6 %}
                      {% assign compare_gap = block.settings.compare_price_gap | default: 6 %}

                      {% if separator != blank %}
                        <span style="margin: 0 {{ separator_gap }}px;">{{ separator }}</span>
                      {% endif %}

                      {% if block.settings.show_compare_price_in_button %}
                        {% assign total_compare_price = 0 %}
                        {% for item in cart.items %}
                          {% if item.variant.compare_at_price > item.variant.price %}
                            {% assign item_compare = item.variant.compare_at_price | times: item.quantity %}
                            {% assign total_compare_price = total_compare_price | plus: item_compare %}
                          {% endif %}
                        {% endfor %}

                        {% if total_compare_price > cart.total_price %}
                          <s class="checkout-button__compare-price" style="margin-right: {{ compare_gap }}px;">{{ total_compare_price | money }}</s>
                        {% endif %}
                      {% endif %}

                      <span class="checkout-button__price">{{ cart.total_price | money }}</span>
                    {% endif %}
                  </span>
                  {% if block.settings.button_icon_position == 'after' %}
                    {% if block.settings.button_custom_icon != blank %}
                      <span class="checkout-button__icon-svg">
                        {{ block.settings.button_custom_icon }}
                      </span>
                    {% elsif block.settings.button_icon != blank %}
                      {% render 'material-icon', icon: block.settings.button_icon, filled: block.settings.button_icon_filled %}
                    {% endif %}
                  {% endif %}
                </button>
                {%- if block.settings.show_additional_checkout_buttons and additional_checkout_buttons -%}
                  <div class="cart__dynamic-checkout-buttons additional-checkout-buttons">
                    {{ content_for_additional_checkout_buttons }}
                  </div>
                {%- endif -%}
                <div class='tnc-checkbox-warning tnc-checkbox-warning--under-button hidden' style='margin-top: 0.6em;'></div>
              </div>
            {% when 'payment_badges' %}
              <div class='payment-badges-block cart-drawer__payment-badges' style="--margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;--margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;--badge-height: {{ block.settings.badge_height | default: 30 }}px;--badge-gap: {{ block.settings.badge_gap | default: 8 }}px;" {{ block.shopify_attributes }}>
                <ul class="payment-badges" role="list">
                  {% assign enabled_payment_types = shop.enabled_payment_types %}
                  {% if block.settings.enabled_payment_types != blank %}
                    {% assign enabled_payment_types = block.settings.enabled_payment_types | remove: ' ' | split: ',' %}
                  {% endif %}

                  {%- for type in enabled_payment_types -%}
                    {% assign payment_type = type | strip %}
                    <li class="list-payment__item">
                      {{ payment_type | payment_type_svg_tag: class: 'icon icon--full-color' }}
                    </li>
                  {%- endfor -%}
                </ul>
              </div>
            {% when 'cart_product_highlights' %}
              {% if block.settings.position == 'footer' %}
                {% render 'product-flag', block: block %}
              {% endif %}
            {% when 'countdown_timer' %}
              {% if block.settings.position == 'footer' %}
                {% render 'countdown-timer-footer', block: block %}
              {% endif %}
            {% when 'delivery_date' %}
              {% if block.settings.position == 'footer' %}
                {% render 'delivery-date', block: block %}
              {% endif %}
            {% when 'custom_html' %}
              {% if block.settings.position == 'footer' %}
                <div class="custom-html-block custom-html-block--footer"
                     style="--margin-top: {{ block.settings.margin_top | default: 16 }}px;
                            --margin-bottom: {{ block.settings.margin_bottom | default: 16 }}px;
                            --padding-horizontal: {{ block.settings.padding_horizontal | default: 16 }}px;"
                     {{ block.shopify_attributes }}>
                  {{ block.settings.html_content }}
                </div>
              {% endif %}
          {% endcase %}
        {% endfor %}
      </div>
    </div>
  </div>

<script>
(function() {
  const cartDrawer = document.querySelector('cart-drawer');
  const overlay = document.querySelector('.cart-drawer__overlay');
  
  if (!cartDrawer || !overlay) return;
  
  // Function to update overlay visibility
  function updateOverlay() {
    const isActive = cartDrawer.classList.contains('active');
    const isEmpty = cartDrawer.classList.contains('is-empty');
    
    // Only show overlay if cart is active AND not empty
    if (isActive && !isEmpty) {
      // Small delay to ensure cart content is loaded
      setTimeout(() => {
        if (!cartDrawer.classList.contains('is-empty')) {
          cartDrawer.setAttribute('show-overlay', '');
        }
      }, 100);
    } else {
      cartDrawer.removeAttribute('show-overlay');
    }
  }
  
  // Watch for class changes on cart-drawer
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.attributeName === 'class') {
        updateOverlay();
      }
    });
  });
  
  observer.observe(cartDrawer, {
    attributes: true,
    attributeFilter: ['class']
  });
  
  // Initial check
  updateOverlay();

  // Comprehensive overlay cleanup (same as QB component)
  const forceCleanup = () => {
    // Force cleanup of cart drawer element
    if (cartDrawer) {
      cartDrawer.classList.remove('active', 'animate', 'is-loaded');
      cartDrawer.removeAttribute('open');
      cartDrawer.removeAttribute('show-overlay');
    }

    // Hide overlays - be very specific
    const overlaySelectors = [
      '#CartDrawer-Overlay',
      '.cart-drawer__overlay'
    ];

    overlaySelectors.forEach(selector => {
      const overlays = document.querySelectorAll(selector);
      overlays.forEach(overlay => {
        overlay.classList.remove('active', 'visible');
        overlay.style.display = 'none';
        overlay.style.visibility = 'hidden';
        overlay.style.opacity = '0';
      });
    });

    // Restore scroll
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
    document.body.classList.remove('overflow-hidden');
  };

  const cleanupOnClose = () => {
    setTimeout(forceCleanup, 50);
  };

  // Listen to native cart close events
  document.addEventListener('cart:close', cleanupOnClose);
  document.addEventListener('drawer:close', cleanupOnClose);

  // Also listen for clicks on close buttons and overlays
  document.addEventListener('click', (e) => {
    const target = e.target;

    // Check if clicked element is a close button or overlay
    if (
      target.matches('.drawer__close, .cart-drawer__close, [aria-label*="Close"], .drawer-overlay, #CartDrawer-Overlay, .cart-drawer__overlay') ||
      target.closest('.drawer__close, .cart-drawer__close, [aria-label*="Close"]')
    ) {
      setTimeout(forceCleanup, 100);
    }
  });
})();
</script>

</cart-drawer>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    function isIE() {
      const ua = window.navigator.userAgent;
      const msie = ua.indexOf('MSIE ');
      const trident = ua.indexOf('Trident/');

      return msie > 0 || trident > 0;
    }

    if (!isIE()) return;
    const cartSubmitInput = document.createElement('input');
    cartSubmitInput.setAttribute('name', 'checkout');
    cartSubmitInput.setAttribute('type', 'hidden');
    document.querySelector('#cart').appendChild(cartSubmitInput);
    document.querySelector('#checkout').addEventListener('click', function (event) {
      document.querySelector('#cart').submit();
    });
  });

  // Update cart drawer is-empty class when cart changes
  function updateCartDrawerEmptyState() {
    const cartDrawer = document.querySelector('cart-drawer');
    if (!cartDrawer) return;

    // Check multiple ways to determine if cart is empty
    const cartItems = cartDrawer.querySelectorAll('.cart-drawer-item');
    const cartForm = cartDrawer.querySelector('.cart__contents');
    const hasEmptyClass = cartForm && cartForm.classList.contains('is-empty');

    const isEmpty = cartItems.length === 0 || hasEmptyClass;

    if (isEmpty) {
      cartDrawer.classList.add('is-empty');
    } else {
      cartDrawer.classList.remove('is-empty');
    }
  }

  // Watch for cart changes
  const cartDrawerObserver = new MutationObserver(function(mutations) {
    updateCartDrawerEmptyState();
  });

  // Listen for cart update events
  document.addEventListener('cart:updated', function() {
    setTimeout(updateCartDrawerEmptyState, 100);
  });

  document.addEventListener('cart:change', function() {
    setTimeout(updateCartDrawerEmptyState, 100);
  });

  // Start observing when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      const cartDrawer = document.querySelector('cart-drawer .drawer__inner');
      if (cartDrawer) {
        cartDrawerObserver.observe(cartDrawer, { childList: true, subtree: true });
        updateCartDrawerEmptyState();
      }
    });
  } else {
    const cartDrawer = document.querySelector('cart-drawer .drawer__inner');
    if (cartDrawer) {
      cartDrawerObserver.observe(cartDrawer, { childList: true, subtree: true });
      updateCartDrawerEmptyState();
    }
  }

  // Dynamic savings badge update for cart drawer
  (function() {
    'use strict';

    function updateSavingsBadge(cartItem, item, badgeTextTemplate) {
      const savingsBadge = cartItem.querySelector('.cart-item__savings-badge');
      if (!savingsBadge) {
        return;
      }

      // Determine compare price (use variant compare_at_price or original_price)
      let comparePrice = 0;
      const actualPrice = item.final_price;

      if (item.variant && item.variant.compare_at_price && item.variant.compare_at_price > actualPrice) {
        comparePrice = item.variant.compare_at_price;
      } else if (item.original_price > actualPrice) {
        comparePrice = item.original_price;
      }

      // If no savings, hide badge
      if (comparePrice === 0 || comparePrice <= actualPrice) {
        savingsBadge.style.display = 'none';
        return;
      }

      savingsBadge.style.display = 'inline-flex';

      // Calculate savings
      const perUnitSavings = comparePrice - actualPrice;
      const totalSavings = perUnitSavings * item.quantity;
      const savingsPercent = Math.round((perUnitSavings * 100) / comparePrice);

      // Format price savings
      const formattedSavings = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: window.Shopify?.currency?.active || 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(totalSavings / 100);

      // Replace placeholders in badge text
      const badgeDisplayText = badgeTextTemplate
        .replace('[percentage]', savingsPercent)
        .replace('[price]', formattedSavings);

      // Update badge text
      savingsBadge.textContent = badgeDisplayText;
    }

    function initDrawerSavingsBadgeUpdates() {
      const cartDrawer = document.querySelector('cart-drawer');
      if (!cartDrawer) return;

      const cartItems = cartDrawer.querySelectorAll('.cart-drawer-item');

      cartItems.forEach(function(cartItem) {
        const quantityInput = cartItem.querySelector('.quantity__input');
        if (!quantityInput) return;

        const savingsBadge = cartItem.querySelector('.cart-item__savings-badge');
        if (!savingsBadge) return;

        // Get initial data
        const variantId = quantityInput.dataset.quantityVariantId;
        if (!variantId) return;

        // Store badge template in data attribute for later use
        const badgeText = savingsBadge.textContent.trim();
        savingsBadge.dataset.badgeTemplate = badgeText;

        // Listen for quantity changes
        quantityInput.addEventListener('change', function() {
          const newQuantity = parseInt(this.value) || 1;

          // Fetch updated cart to get accurate pricing
          fetch('/cart.js')
            .then(response => response.json())
            .then(cart => {
              const item = cart.items.find(i => i.variant_id == variantId);
              if (item) {
                const badgeTemplate = savingsBadge.dataset.badgeTemplate;
                updateSavingsBadge(cartItem, item, badgeTemplate);
              }
            })
            .catch(error => {
              console.error('Error updating savings badge:', error);
            });
        });

        // Also listen for input events for real-time updates
        quantityInput.addEventListener('input', function() {
          const newQuantity = parseInt(this.value) || 1;

          // Fetch cart data
          fetch('/cart.js')
            .then(response => response.json())
            .then(cart => {
              const item = cart.items.find(i => i.variant_id == variantId);
              if (item) {
                const badgeTemplate = savingsBadge.dataset.badgeTemplate;
                updateSavingsBadge(cartItem, item, badgeTemplate);
              }
            })
            .catch(error => {
              console.error('Error updating savings badge:', error);
            });
        });
      });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDrawerSavingsBadgeUpdates);
    } else {
      initDrawerSavingsBadgeUpdates();
    }

    // Re-initialize after cart drawer opens and updates
    document.addEventListener('cart:updated', function() {
      setTimeout(initDrawerSavingsBadgeUpdates, 200);
    });

    document.addEventListener('cart:change', function() {
      setTimeout(initDrawerSavingsBadgeUpdates, 200);
    });

    // Also listen for when cart drawer is opened
    const cartDrawerElement = document.querySelector('cart-drawer');
    if (cartDrawerElement) {
      const drawerObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'open' && cartDrawerElement.hasAttribute('open')) {
            setTimeout(initDrawerSavingsBadgeUpdates, 200);
          }
        });
      });

      drawerObserver.observe(cartDrawerElement, {
        attributes: true,
        attributeFilter: ['open']
      });
    }
  })();
</script>
