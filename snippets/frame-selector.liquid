{%- comment -%}
  Frame Selector Block
  Displays frame options from product metafield
  Uses custom.frame_selector metafield to manually select frame products
{%- endcomment -%}

{%- liquid
  assign block_id = block.id
  assign heading = block.settings.heading | default: "Choose your frame"
  assign current_product = product
  
  # Get frame products from metafield (Product List type)
  assign frame_selector_metafield = current_product.metafields.custom.frame_selector
  assign frame_products = frame_selector_metafield.value
  
  # If metafield is blank or empty, create empty array
  if frame_selector_metafield == blank or frame_products == blank
    assign frame_products = blank | split: ''
  endif
-%}

{%- comment -%} Always show the block container, even if empty, for debugging {%- endcomment -%}
<div class="frame-selector frame-selector-{{ block_id }}" {{ block.shopify_attributes }}>
  {%- if frame_products.size == 0 -%}
    {%- comment -%} Debug message if no products found in metafield {%- endcomment -%}
    {%- if block.settings.show_debug -%}
      {%- liquid
        assign metafield_exists = false
        if frame_selector_metafield != blank
          assign metafield_exists = true
        endif
        assign value_exists = false
        if frame_selector_metafield.value != blank
          assign value_exists = true
        endif
      -%}
      <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
        <p style="margin: 0; color: #856404;"><strong>Frame Selector Debug:</strong> No frame products found in metafield.</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Please add products to the <strong>custom.frame_selector</strong> metafield for this product.</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 11px;">Metafield exists: {{ metafield_exists }}, Value exists: {{ value_exists }}, Products found: {{ frame_products.size }}</p>
        {%- if frame_selector_metafield != blank -%}
          {%- liquid
            assign test_count = 0
            for test_item in frame_selector_metafield.value
              assign test_count = test_count | plus: 1
            endfor
          -%}
          <p style="margin: 5px 0 0 0; color: #856404; font-size: 11px;">Items in metafield.value: {{ test_count }}</p>
          {%- if test_count > 0 -%}
            {%- for test_item in frame_selector_metafield.value limit: 1 -%}
              <p style="margin: 5px 0 0 0; color: #856404; font-size: 11px;">First item ID: {{ test_item.id }}, Title: {{ test_item.title }}</p>
            {%- endfor -%}
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- endif -%}
  {%- else -%}
    {%- style -%}
      .frame-selector-{{ block_id }} {
        margin-top: {{ block.settings.margin_top }}px;
        margin-bottom: {{ block.settings.margin_bottom }}px;
      }
      
      .frame-selector-{{ block_id }} .frame-selector-heading {
        font-family: {{ settings.type_header_font.family }}, {{ settings.type_header_font.fallback_families }};
        font-size: {{ block.settings.heading_font_size_mobile }}px;
        font-weight: {{ block.settings.heading_font_weight }};
        color: {{ block.settings.heading_color }};
        margin: 0 0 {{ block.settings.heading_margin_bottom }}px 0;
        text-align: {{ block.settings.heading_alignment }};
      }
      
      @media screen and (min-width: 750px) {
        .frame-selector-{{ block_id }} .frame-selector-heading {
          font-size: {{ block.settings.heading_font_size_desktop }}px;
        }
      }
      
      .frame-selector-{{ block_id }} .frame-selector-grid {
        display: grid;
        grid-template-columns: repeat({{ frame_products.size }}, 1fr);
        gap: {{ block.settings.frame_gap }}px;
        margin-top: {{ block.settings.grid_margin_top }}px;
      }
      
      @media screen and (max-width: 749px) {
        .frame-selector-{{ block_id }} .frame-selector-grid {
          gap: {{ block.settings.frame_gap_mobile }}px;
        }
      }
      
      .frame-selector-{{ block_id }} .frame-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: {{ block.settings.frame_border_radius }}px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        background: {{ block.settings.frame_background }};
        border: {{ block.settings.frame_border_width }}px solid {{ block.settings.frame_border_color }};
        text-decoration: none;
        display: block;
      }
      
      .frame-selector-{{ block_id }} .frame-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .frame-selector-{{ block_id }} .frame-item.frame-item-selected {
        border: {{ block.settings.selected_border_width }}px solid {{ block.settings.selected_border_color }};
        box-shadow: 0 0 0 {{ block.settings.selected_border_width }}px {{ block.settings.selected_border_color }};
      }
      
      .frame-selector-{{ block_id }} .frame-item-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      
      .frame-selector-{{ block_id }} .frame-item-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        padding: 12px;
        color: {{ block.settings.frame_text_color }};
        font-family: {{ settings.type_body_font.family }}, {{ settings.type_body_font.fallback_families }};
        font-size: {{ block.settings.frame_name_font_size_mobile }}px;
        font-weight: {{ block.settings.frame_name_font_weight }};
      }
      
      @media screen and (min-width: 750px) {
        .frame-selector-{{ block_id }} .frame-item-overlay {
          font-size: {{ block.settings.frame_name_font_size_desktop }}px;
          padding: 16px;
        }
      }
      
    {%- endstyle -%}
    
    {%- if heading != blank -%}
      <h3 class="frame-selector-heading">{{ heading }}</h3>
    {%- endif -%}
    
    <div class="frame-selector-grid">
      {%- for frame_product in frame_products -%}
        {%- liquid
          assign is_selected = false
          if frame_product.id == current_product.id
            assign is_selected = true
          endif
          
          # Extract frame name from product title
          # Handle formats like "The Aero Black (Sleep enhancer lens)" -> "The Aero"
          assign frame_display_name = frame_product.title
          
          # Remove anything in parentheses
          if frame_product.title contains '('
            assign title_parts = frame_product.title | split: '('
            assign frame_display_name = title_parts[0] | strip
          endif
          
          # Extract just the frame name (remove color/variant info)
          # "The Aero Black" -> "The Aero"
          assign title_words = frame_display_name | split: ' '
          if title_words.size >= 2
            assign frame_display_name = title_words[0] | append: ' ' | append: title_words[1]
          endif
          
          assign frame_image = frame_product.featured_image
          if frame_image == blank
            assign frame_image = frame_product.images.first
          endif
        -%}
        
        <a 
          href="{{ frame_product.url }}" 
          class="frame-item{% if is_selected %} frame-item-selected{% endif %}"
          data-frame-product-id="{{ frame_product.id }}"
        >
          {%- if frame_image != blank -%}
            {{ frame_image | image_url: width: 400 | image_tag: loading: 'lazy', alt: frame_display_name, class: 'frame-item-image' }}
          {%- else -%}
            <div class="frame-item-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">
              {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          {%- endif -%}
          
          <div class="frame-item-overlay">
            {{ frame_display_name }}
          </div>
        </a>
      {%- endfor -%}
    </div>
  {%- endif -%}
</div>
