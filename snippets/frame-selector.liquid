{%- comment -%}
  Frame Selector Block
  Allows customers to choose their frame while maintaining the same lens type
  Filters products by lens type tags: "sleep enhancer lens" or "everyday lens"
{%- endcomment -%}

{%- liquid
  assign block_id = block.id
  assign heading = block.settings.heading | default: "Choose your frame"
  assign current_product = product
  
  # Determine lens type from current product tags (flexible matching)
  assign lens_type = null
  assign lens_type_tag = null
  
  # Check all product tags for lens type indicators
  for tag in current_product.tags
    assign tag_lower = tag | downcase
    # Check for sleep enhancer variations
    if tag_lower contains 'sleep enhancer' or tag_lower contains 'sleep-enhancer'
      assign lens_type = 'sleep enhancer lens'
      assign lens_type_tag = tag
      break
    # Check for everyday lens variations
    elsif tag_lower contains 'everyday lens' or tag_lower contains 'everyday-lens' or tag_lower == 'everyday'
      assign lens_type = 'everyday lens'
      assign lens_type_tag = tag
      break
    endif
  endfor
  
  # Find products with same lens type for each frame
  assign aero_product = null
  assign monaco_product = null
  assign origin_product = null
  assign frame_products = blank | split: ''
  
  if lens_type != blank
    # Try multiple methods to find products
    # Method 1: Search through collections.all.products if available
    if collections.all.products.size > 0
      for collection_product in collections.all.products
        # Flexible tag matching - check if product has matching lens type tag
        assign has_matching_lens = false
        for tag in collection_product.tags
          assign tag_lower = tag | downcase
          if lens_type == 'sleep enhancer lens'
            if tag_lower contains 'sleep enhancer' or tag_lower contains 'sleep-enhancer'
              assign has_matching_lens = true
              break
            endif
          elsif lens_type == 'everyday lens'
            if tag_lower contains 'everyday lens' or tag_lower contains 'everyday-lens' or tag_lower == 'everyday'
              assign has_matching_lens = true
              break
            endif
          endif
        endfor
        
        if has_matching_lens
          assign product_title_lower = collection_product.title | downcase
          
          if product_title_lower contains 'aero' and aero_product == null
            assign aero_product = collection_product
          elsif product_title_lower contains 'monaco' and monaco_product == null
            assign monaco_product = collection_product
          elsif product_title_lower contains 'origin' and origin_product == null
            assign origin_product = collection_product
          endif
        endif
      endfor
    endif
    
    # Method 2: Search through product collections if Method 1 didn't work
    if aero_product == null or monaco_product == null or origin_product == null
      for collection in collections
        for collection_product in collection.products
          # Flexible tag matching
          assign has_matching_lens = false
          for tag in collection_product.tags
            assign tag_lower = tag | downcase
            if lens_type == 'sleep enhancer lens'
              if tag_lower contains 'sleep enhancer' or tag_lower contains 'sleep-enhancer'
                assign has_matching_lens = true
                break
              endif
            elsif lens_type == 'everyday lens'
              if tag_lower contains 'everyday lens' or tag_lower contains 'everyday-lens' or tag_lower == 'everyday'
                assign has_matching_lens = true
                break
              endif
            endif
          endfor
          
          if has_matching_lens
            assign product_title_lower = collection_product.title | downcase
            
            if product_title_lower contains 'aero' and aero_product == null
              assign aero_product = collection_product
            elsif product_title_lower contains 'monaco' and monaco_product == null
              assign monaco_product = collection_product
            elsif product_title_lower contains 'origin' and origin_product == null
              assign origin_product = collection_product
            endif
          endif
        endfor
      endfor
    endif
    
    # Build frame_products array in display order
    if aero_product != null
      assign frame_products = frame_products | push: aero_product
    endif
    if monaco_product != null
      assign frame_products = frame_products | push: monaco_product
    endif
    if origin_product != null
      assign frame_products = frame_products | push: origin_product
    endif
  endif
-%}

{%- comment -%} Debug: Show block even if no products found to help troubleshoot {%- endcomment -%}
<div class="frame-selector frame-selector-{{ block_id }}" {{ block.shopify_attributes }}>
  {%- if lens_type == blank -%}
    {%- comment -%} Debug message if no lens type found {%- endcomment -%}
    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
      <p style="margin: 0; color: #856404;"><strong>Frame Selector Debug:</strong> No lens type detected. Current product tags: {{ current_product.tags | join: ', ' }}</p>
      <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Make sure your product has either "sleep enhancer lens" or "everyday lens" tag.</p>
    </div>
  {%- elsif frame_products.size == 0 -%}
    {%- comment -%} Debug message if no frame products found {%- endcomment -%}
    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
      <p style="margin: 0; color: #856404;"><strong>Frame Selector Debug:</strong> Found lens type "{{ lens_type }}" but no matching frame products found.</p>
      <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Looking for products with tags containing "{{ lens_type }}" and titles containing "Aero", "Monaco", or "Origin".</p>
    </div>
  {%- endif -%}

{%- if lens_type != blank and frame_products.size > 0 -%}
    {%- style -%}
      .frame-selector-{{ block_id }} {
        margin-top: {{ block.settings.margin_top }}px;
        margin-bottom: {{ block.settings.margin_bottom }}px;
      }
      
      .frame-selector-{{ block_id }} .frame-selector-heading {
        font-family: {{ settings.type_header_font.family }}, {{ settings.type_header_font.fallback_families }};
        font-size: {{ block.settings.heading_font_size_mobile }}px;
        font-weight: {{ block.settings.heading_font_weight }};
        color: {{ block.settings.heading_color }};
        margin: 0 0 {{ block.settings.heading_margin_bottom }}px 0;
        text-align: {{ block.settings.heading_alignment }};
      }
      
      @media screen and (min-width: 750px) {
        .frame-selector-{{ block_id }} .frame-selector-heading {
          font-size: {{ block.settings.heading_font_size_desktop }}px;
        }
      }
      
      .frame-selector-{{ block_id }} .frame-selector-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: {{ block.settings.frame_gap }}px;
        margin-top: {{ block.settings.grid_margin_top }}px;
      }
      
      @media screen and (max-width: 749px) {
        .frame-selector-{{ block_id }} .frame-selector-grid {
          gap: {{ block.settings.frame_gap_mobile }}px;
        }
      }
      
      .frame-selector-{{ block_id }} .frame-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: {{ block.settings.frame_border_radius }}px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        background: {{ block.settings.frame_background }};
        border: {{ block.settings.frame_border_width }}px solid {{ block.settings.frame_border_color }};
        text-decoration: none;
        display: block;
      }
      
      .frame-selector-{{ block_id }} .frame-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .frame-selector-{{ block_id }} .frame-item.frame-item-selected {
        border: {{ block.settings.selected_border_width }}px solid {{ block.settings.selected_border_color }};
        box-shadow: 0 0 0 {{ block.settings.selected_border_width }}px {{ block.settings.selected_border_color }};
      }
      
      .frame-selector-{{ block_id }} .frame-item-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      
      .frame-selector-{{ block_id }} .frame-item-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        padding: 12px;
        color: {{ block.settings.frame_text_color }};
        font-family: {{ settings.type_body_font.family }}, {{ settings.type_body_font.fallback_families }};
        font-size: {{ block.settings.frame_name_font_size_mobile }}px;
        font-weight: {{ block.settings.frame_name_font_weight }};
      }
      
      @media screen and (min-width: 750px) {
        .frame-selector-{{ block_id }} .frame-item-overlay {
          font-size: {{ block.settings.frame_name_font_size_desktop }}px;
          padding: 16px;
        }
      }
      
      .frame-selector-{{ block_id }} .frame-item-selected-label {
        position: absolute;
        top: 8px;
        right: 8px;
        background: {{ block.settings.selected_badge_background }};
        color: {{ block.settings.selected_badge_text_color }};
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: {{ settings.type_body_font.family }}, {{ settings.type_body_font.fallback_families }};
      }
    {%- endstyle -%}
    
    {%- if heading != blank -%}
      <h3 class="frame-selector-heading">{{ heading }}</h3>
    {%- endif -%}
    
    <div class="frame-selector-grid">
      {%- for frame_product in frame_products limit: 3 -%}
        {%- liquid
          assign is_selected = false
          if frame_product.id == current_product.id
            assign is_selected = true
          endif
          
          # Extract frame name from product title
          # Handle formats like "The Aero Black (Sleep enhancer lens)" -> "The Aero"
          assign frame_display_name = frame_product.title
          
          # Remove anything in parentheses
          if frame_product.title contains '('
            assign title_parts = frame_product.title | split: '('
            assign frame_display_name = title_parts[0] | strip
          endif
          
          # Extract just the frame name (remove color/variant info)
          # "The Aero Black" -> "The Aero"
          assign title_words = frame_display_name | split: ' '
          if title_words.size >= 2
            assign frame_display_name = title_words[0] | append: ' ' | append: title_words[1]
          endif
          
          assign frame_image = frame_product.featured_image
          if frame_image == blank
            assign frame_image = frame_product.images.first
          endif
        -%}
        
        <a 
          href="{{ frame_product.url }}" 
          class="frame-item{% if is_selected %} frame-item-selected{% endif %}"
          data-frame-product-id="{{ frame_product.id }}"
        >
          {%- if is_selected -%}
            <span class="frame-item-selected-label">Selected</span>
          {%- endif -%}
          
          {%- if frame_image != blank -%}
            {{ frame_image | image_url: width: 400 | image_tag: loading: 'lazy', alt: frame_display_name, class: 'frame-item-image' }}
          {%- else -%}
            <div class="frame-item-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">
              {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          {%- endif -%}
          
          <div class="frame-item-overlay">
            {{ frame_display_name }}
          </div>
        </a>
      {%- endfor -%}
    </div>
{%- endif -%}
</div>
