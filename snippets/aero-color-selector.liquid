{%- comment -%}
  Aero Color Selector Block
  Displays color swatches for Aero frame variants
  Only shows on Aero products
{%- endcomment -%}

{%- liquid
  assign block_id = block.id
  assign heading = block.settings.heading | default: "Choose your color"
  assign current_product = product
  
  # Check if current product is an Aero product
  assign is_aero = false
  assign current_title_lower = current_product.title | downcase
  if current_title_lower contains 'aero'
    assign is_aero = true
  endif
  
  # Find all Aero color variants
  assign aero_variants = blank | split: ''
  assign current_aero_variant = null
  
  # Method 0: Try metafield first (most reliable - like frame selector)
  assign aero_colors_metafield = current_product.metafields.custom.aero_color_selector
  if aero_colors_metafield != blank and aero_colors_metafield.value != blank
    assign aero_variants = aero_colors_metafield.value
    # Find current product in the list
    for variant_product in aero_variants
      if variant_product.id == current_product.id
        assign current_aero_variant = variant_product
        break
      endif
    endfor
  endif
  
  # Only try auto-finding if metafield didn't work
  if is_aero and aero_variants.size == 0
    # Method 1: Search through current product's collections first (most reliable)
    for product_collection in current_product.collections
      for collection_product in product_collection.products
        assign product_title_lower = collection_product.title | downcase
        if product_title_lower contains 'aero'
          # Check if we already have this product
          assign already_added = false
          for existing_variant in aero_variants
            if existing_variant.id == collection_product.id
              assign already_added = true
              break
            endif
          endfor
          unless already_added
            assign aero_variants = aero_variants | push: collection_product
            if collection_product.id == current_product.id
              assign current_aero_variant = collection_product
            endif
          endunless
        endif
      endfor
    endfor
    
    # Method 2: Try collections.all if available and we haven't found enough
    if aero_variants.size < 3 and collections.all != blank and collections.all.products.size > 0
      for collection_product in collections.all.products
        assign product_title_lower = collection_product.title | downcase
        if product_title_lower contains 'aero'
          # Check if we already have this product
          assign already_added = false
          for existing_variant in aero_variants
            if existing_variant.id == collection_product.id
              assign already_added = true
              break
            endif
          endfor
          unless already_added
            assign aero_variants = aero_variants | push: collection_product
            if collection_product.id == current_product.id
              assign current_aero_variant = collection_product
            endif
          endunless
        endif
      endfor
    endif
    
    # Method 3: Try to find products by handle using all_products
    # Known Aero product handles (try common variations)
    assign aero_handles = 'the-aero-black,the-aero-night-moss,the-aero-tortoise-ion-clear,the-aero-tortoise,the-aero-ion-clear' | split: ','
    for handle in aero_handles
      assign test_product = all_products[handle]
      if test_product != blank
        assign product_title_lower = test_product.title | downcase
        if product_title_lower contains 'aero'
          # Check if we already have this product
          assign already_added = false
          for existing_variant in aero_variants
            if existing_variant.id == test_product.id
              assign already_added = true
              break
            endif
          endfor
          unless already_added
            assign aero_variants = aero_variants | push: test_product
            if test_product.id == current_product.id
              assign current_aero_variant = test_product
            endif
          endunless
        endif
      endif
    endfor
    
    # Method 4: Search through all collections if we still haven't found enough
    if aero_variants.size < 3
      for collection in collections
        unless collection.handle == 'all'
          for collection_product in collection.products
            assign product_title_lower = collection_product.title | downcase
            if product_title_lower contains 'aero'
              # Check if we already have this product
              assign already_added = false
              for existing_variant in aero_variants
                if existing_variant.id == collection_product.id
                  assign already_added = true
                  break
                endif
              endfor
              unless already_added
                assign aero_variants = aero_variants | push: collection_product
                if collection_product.id == current_product.id
                  assign current_aero_variant = collection_product
                endif
              endunless
            endif
          endfor
        endunless
      endfor
    endif
    
    # Make sure current product is in the list if it's an Aero
    if is_aero
      assign found_in_list = false
      for variant in aero_variants
        if variant.id == current_product.id
          assign found_in_list = true
          break
        endif
      endfor
      unless found_in_list
        assign aero_variants = aero_variants | push: current_product
      endunless
    endif
  endif
-%}

{%- comment -%} Debug: Always show block container to help troubleshoot {%- endcomment -%}
<div class="aero-color-selector aero-color-selector-{{ block_id }}" {{ block.shopify_attributes }}>
  {%- if is_aero == false -%}
    {%- if block.settings.show_debug -%}
      <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
        <p style="margin: 0; color: #856404;"><strong>Aero Color Selector Debug:</strong> Current product is not an Aero product.</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Product title: "{{ current_product.title }}"</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">This block only shows on Aero products.</p>
      </div>
    {%- endif -%}
  {%- elsif aero_variants.size == 0 -%}
    {%- if block.settings.show_debug -%}
      <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
        <p style="margin: 0; color: #856404;"><strong>Aero Color Selector Debug:</strong> Found Aero product but no variants found.</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Product title: "{{ current_product.title }}"</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Product handle: "{{ current_product.handle }}"</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Product collections: {% for coll in current_product.collections %}{{ coll.handle }}{% unless forloop.last %}, {% endunless %}{% endfor %}</p>
        {%- liquid
          assign metafield_exists = false
          if current_product.metafields.custom.aero_color_selector != blank
            assign metafield_exists = true
          endif
        -%}
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Metafield (custom.aero_color_selector) exists: {{ metafield_exists }}</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Searched through product collections, collections.all, all_products, and all collections but found 0 Aero variants.</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 11px;"><strong>Solution:</strong> Add all Aero color products to the <strong>custom.aero_color_selector</strong> metafield (Product List type) for this product, similar to how the frame selector works.</p>
      </div>
    {%- endif -%}
  {%- elsif aero_variants.size == 1 -%}
    {%- if block.settings.show_debug -%}
      <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
        <p style="margin: 0; color: #856404;"><strong>Aero Color Selector Debug:</strong> Found {{ aero_variants.size }} Aero variant(s).</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 12px;">Need at least 2 variants to show selector. Found: {{ aero_variants.size }}</p>
        {%- for variant in aero_variants -%}
          <p style="margin: 5px 0 0 0; color: #856404; font-size: 11px;">- {{ variant.title }}</p>
        {%- endfor -%}
      </div>
    {%- endif -%}
  {%- elsif aero_variants.size > 1 -%}
  <div class="aero-color-selector aero-color-selector-{{ block_id }}" {{ block.shopify_attributes }}>
    {%- style -%}
      .aero-color-selector-{{ block_id }} {
        margin-top: {{ block.settings.margin_top }}px;
        margin-bottom: {{ block.settings.margin_bottom }}px;
      }
      
      .aero-color-selector-{{ block_id }} .color-selector-heading {
        font-family: {{ settings.type_header_font.family }}, {{ settings.type_header_font.fallback_families }};
        font-size: {{ block.settings.heading_font_size_mobile }}px;
        font-weight: {{ block.settings.heading_font_weight }};
        color: {{ block.settings.heading_color }};
        margin: 0 0 {{ block.settings.heading_margin_bottom }}px 0;
        text-align: {{ block.settings.heading_alignment }};
      }
      
      @media screen and (min-width: 750px) {
        .aero-color-selector-{{ block_id }} .color-selector-heading {
          font-size: {{ block.settings.heading_font_size_desktop }}px;
        }
      }
      
      .aero-color-selector-{{ block_id }} .color-swatches {
        display: flex;
        gap: {{ block.settings.swatch_gap }}px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: {{ block.settings.swatches_margin_top }}px;
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: {{ block.settings.swatch_label_gap }}px;
        text-decoration: none;
        transition: transform 0.2s ease;
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch-item:hover {
        transform: translateY(-2px);
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch {
        width: {{ block.settings.swatch_size }}px;
        height: {{ block.settings.swatch_size }}px;
        border-radius: 50%;
        border: {{ block.settings.swatch_border_width }}px solid {{ block.settings.swatch_border_color }};
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        background: {{ block.settings.swatch_background }};
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch:hover {
        transform: scale(1.05);
        border-color: {{ block.settings.swatch_hover_border_color }};
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch.swatch-selected {
        border-color: {{ block.settings.selected_border_color }};
        border-width: {{ block.settings.selected_border_width }}px;
        box-shadow: 0 0 0 2px #fff, 0 0 0 {{ block.settings.selected_border_width | plus: 2 }}px {{ block.settings.selected_border_color }};
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 50%;
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch-label {
        font-family: {{ settings.type_body_font.family }}, {{ settings.type_body_font.fallback_families }};
        font-size: {{ block.settings.swatch_label_font_size }}px;
        font-weight: {{ block.settings.swatch_label_font_weight }};
        color: {{ block.settings.swatch_label_color }};
        text-align: center;
        margin: 0;
        line-height: 1.2;
      }
      
      .aero-color-selector-{{ block_id }} .color-swatch-item.swatch-selected .color-swatch-label {
        color: {{ block.settings.selected_label_color }};
        font-weight: {{ block.settings.selected_label_font_weight }};
      }
    {%- endstyle -%}
    
    {%- if heading != blank -%}
      <h3 class="color-selector-heading">{{ heading }}</h3>
    {%- endif -%}
    
    <div class="color-swatches">
      {%- for variant_product in aero_variants -%}
        {%- liquid
          assign is_selected = false
          if variant_product.id == current_product.id
            assign is_selected = true
          endif
          
          # Extract color name from product title
          # "The Aero Black" -> "Black"
          # "The Aero Night Moss" -> "Night Moss"
          # "The Aero Tortoise/ Ion-Clear" -> "Tortoise/ Ion-Clear"
          assign color_name = variant_product.title
          
          # Remove anything in parentheses first
          if variant_product.title contains '('
            assign title_parts = variant_product.title | split: '('
            assign color_name = title_parts[0] | strip
          endif
          
          # Remove "The Aero" to get just the color
          assign color_name = color_name | remove: 'The Aero' | strip
          
          # If nothing left after removal, use "Default"
          if color_name == blank
            assign color_name = 'Default'
          endif
          
          # Get swatch image - prefer custom metafield, then fall back to product image
          assign swatch_image = null
          assign swatch_metafield = variant_product.metafields.custom.swatch_image
          if swatch_metafield != blank and swatch_metafield.value != blank
            assign swatch_image = swatch_metafield.value
          endif
          if swatch_image == blank
            assign swatch_image = variant_product.featured_image
          endif
          if swatch_image == blank
            assign swatch_image = variant_product.images.first
          endif
        -%}
        
        <a 
          href="{{ variant_product.url }}" 
          class="color-swatch-item{% if is_selected %} swatch-selected{% endif %}"
          data-variant-product-id="{{ variant_product.id }}"
        >
          <div class="color-swatch{% if is_selected %} swatch-selected{% endif %}">
            {%- if swatch_image != blank -%}
              {{ swatch_image | image_url: width: 200 | image_tag: loading: 'lazy', alt: color_name, class: 'color-swatch-image' }}
            {%- else -%}
              <div class="color-swatch-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">
                {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
              </div>
            {%- endif -%}
          </div>
          <p class="color-swatch-label">{{ color_name }}</p>
        </a>
      {%- endfor -%}
    </div>
  </div>
{%- endif -%}
