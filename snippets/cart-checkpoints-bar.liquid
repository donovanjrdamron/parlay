{% liquid
  assign is_quantity = false
  if block.settings.goal_type == 'quantity'
    assign is_quantity = true
  endif

  if is_quantity
    assign goal_multiplier = 1.0
    assign goal_max_reference = items_count
  else
    assign goal_multiplier = 100.00
    assign goal_max_reference = cart.items_subtotal_price
  endif
  
  if block.settings.enable_goal_1
    assign highest_goal = block.settings.goal_1_amount | times: goal_multiplier
  endif
  if block.settings.enable_goal_2
    assign highest_goal = block.settings.goal_2_amount | times: goal_multiplier
  endif
  if block.settings.enable_goal_3
    assign highest_goal = block.settings.goal_3_amount | times: goal_multiplier
  endif
    
  assign bar_progress = goal_max_reference | divided_by: highest_goal | times: 100.00
  assign all_goals_reached = false
  if bar_progress >= 100.00
    assign all_goals_reached = true
    assign bar_progress = 100
  endif

  assign next_goal_text = nil
  if block.settings.enable_goal_1
    assign goal_1_position = block.settings.goal_1_amount | divided_by: highest_goal | times: goal_multiplier | times: 100.00
    if goal_1_position > bar_progress and next_goal_text == nil
      assign next_goal_text = block.settings.goal_1_text
      assign next_goal = block.settings.goal_1_amount | times: goal_multiplier
    endif
  endif
  if block.settings.enable_goal_2
    assign goal_2_position = block.settings.goal_2_amount | divided_by: highest_goal | times: goal_multiplier | times: 100.00
    if goal_2_position > bar_progress and next_goal_text == nil
      assign next_goal_text = block.settings.goal_2_text
      assign next_goal = block.settings.goal_2_amount | times: goal_multiplier
    endif
  endif
  if block.settings.enable_goal_3
    assign goal_3_position = block.settings.goal_3_amount | divided_by: highest_goal | times: goal_multiplier | times: 100.00
    if goal_3_position > bar_progress and next_goal_text == nil
      assign next_goal_text = block.settings.goal_3_text
      assign next_goal = block.settings.goal_3_amount | times: goal_multiplier
    endif
  endif
%}

{% capture goal_difference_html %}
  {% if is_quantity %}
    {{ next_goal | minus: items_count | round }}
  {% else %}
    <span>{{ next_goal | minus: cart.items_subtotal_price | money_without_trailing_zeros }}</span>
  {% endif %}
{% endcapture %}

<div class="cart-progress cart-checkpoints"
     style="--mobile-text-size: {{ block.settings.labels_mobile_text_size | divided_by: 10.0 }}rem;
            --desktop-text-size: {{ block.settings.labels_desktop_text_size | divided_by: 10.0 }}rem;
            --margin-top: {{ block.settings.margin_top | divided_by: 10.0 }}rem;
            --margin-bottom: {{ block.settings.margin_bottom | divided_by: 10.0 }}rem;
            --text-font-size: {{ block.settings.text_font_size | default: 14 }}px;
            --text-max-width: {{ block.settings.text_max_width | default: 600 }}px;
            --text-color: {{ block.settings.text_color | default: '#000000' }};
            --text-font-weight: {{ block.settings.text_font_weight | default: 400 }};
            --text-margin-bottom: {{ block.settings.text_margin_bottom | default: 10 }}px;
            {% if block.settings.bar_gradient != blank %}
              --bar-background: {{ block.settings.bar_gradient }};
            {% else %}
              --bar-background: {{ block.settings.bar_color | default: '#000000' }};
            {% endif %}
            --icon-bg: {{ block.settings.icon_bg_color | default: '#FFFFFF' }};
            --icon-color: {{ block.settings.icon_color | default: '#000000' }};
            --icon-size: {{ block.settings.icon_size | default: 36 }}px;
            --icon-border-radius: {{ block.settings.icon_border_radius | default: 50 }}%;
            --icon-border-width: {{ block.settings.icon_border_width | default: 0 }}px;
            --icon-border-color: {{ block.settings.icon_border_color | default: '#000000' }};"
     {{ block.shopify_attributes }}>
  <p class="cart-progress__text">
    {% if all_goals_reached == false %}
      {{ block.settings.progress_message | replace: '[amount]', goal_difference_html | replace: '[next_goal]', next_goal_text }}
    {% else %}
      {{ block.settings.success_message }}
    {% endif %}
  </p>
  <div class="cart-progress__bar">
    <div class="cart-progress__bar__progress" style="width: {{ bar_progress }}%;">&nbsp</div>
    {% if block.settings.enable_goal_1 %}
      <div class="cart-progress__bar__badge cart-checkpoints__icon" style="--position:{{ goal_1_position }}%;">
        <span class="material-symbols-outlined{% if block.settings.goal_1_icon_filled %} filled{% endif %}">
          {{ block.settings.goal_1_icon | strip | downcase | replace: ' ', '_' }}
        </span>
        {% if block.settings.goal_1_label != blank %}
          <span class='cart-checkpoints__label custom-font-size'>
            {{ block.settings.goal_1_label }}
          </span>
        {% endif %}
      </div>
    {% endif %}
    {% if block.settings.enable_goal_2 %}
      <div class="cart-progress__bar__badge cart-checkpoints__icon" style="--position:{{ goal_2_position }}%;">
        <span class="material-symbols-outlined{% if block.settings.goal_2_icon_filled %} filled{% endif %}">
          {{ block.settings.goal_2_icon | strip | downcase | replace: ' ', '_' }}
        </span>
        {% if block.settings.goal_2_label != blank %}
          <span class='cart-checkpoints__label custom-font-size'>
            {{ block.settings.goal_2_label }}
          </span>
        {% endif %}
      </div>
    {% endif %}
    {% if block.settings.enable_goal_3 %}
      <div class="cart-progress__bar__badge cart-checkpoints__icon" style="--position:{{ goal_3_position }}%;">
        <span class="material-symbols-outlined{% if block.settings.goal_3_icon_filled %} filled{% endif %}">
          {{ block.settings.goal_3_icon | strip | downcase | replace: ' ', '_' }}
        </span>
        {% if block.settings.goal_3_label != blank %}
          <span class='cart-checkpoints__label custom-font-size'>
            {{ block.settings.goal_3_label }}
          </span>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<style>
  .cart-checkpoints .cart-progress__text {
    font-size: var(--text-font-size, 14px);
    max-width: var(--text-max-width, 600px);
    color: var(--text-color, #000000);
    font-weight: var(--text-font-weight, 400);
    margin: 0 auto var(--text-margin-bottom, 10px);
    text-align: center;
  }

  .cart-checkpoints .cart-progress__bar__progress {
    background: var(--bar-background, #000000);
    background-size: 100% 100%;
    animation: none !important;
    transition: width 0.3s ease;
  }

  .cart-checkpoints .cart-progress__bar__badge {
    background: var(--icon-bg, #FFFFFF);
    border-radius: var(--icon-border-radius, 50%);
    width: var(--icon-size, 36px);
    height: var(--icon-size, 36px);
    display: flex;
    align-items: center;
    justify-content: center;
    border: var(--icon-border-width, 0px) solid var(--icon-border-color, #000000);
  }

  .cart-checkpoints .cart-progress__bar__badge .material-symbols-outlined {
    color: var(--icon-color, #000000);
    font-size: calc(var(--icon-size, 36px) * 0.6);
  }
</style>
