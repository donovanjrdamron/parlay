{% comment %}
  Product Video Slider Snippet
  Compact video slider for product pages with title and spacing controls
  Usage: {% render 'product-video-slider', block: block %}
{% endcomment %}

<div class="pvs-wrapper" style="
  margin-top: {{ block.settings.margin_top }}px;
  margin-bottom: {{ block.settings.margin_bottom }}px;
" {{ block.shopify_attributes }}>
  {% comment %} Title {% endcomment %}
  {% if block.settings.title != blank %}
    <h3 class="pvs-title" style="
      font-size: {{ block.settings.title_font_size }}px;
      font-weight: {{ block.settings.title_font_weight }};
      color: {{ block.settings.title_color }};
      margin-bottom: {{ block.settings.title_spacing }}px;
      text-align: {{ block.settings.title_alignment }};
    ">
      {{ block.settings.title }}
    </h3>
  {% endif %}

  {% comment %} Video Slider {% endcomment %}
  <div class="pvs-slider" data-pvs-slider>
    <div class="pvs-slider-viewport" data-pvs-viewport>
      <div class="pvs-slider-track" data-pvs-track>
        {% assign max_videos = block.settings.number_of_videos %}
        {% for i in (1..max_videos) %}
          {% assign video_key = 'video_' | append: i %}
          {% assign video = block.settings[video_key] %}
          <div class="pvs-slide" data-pvs-slide>
            <div class="pvs-video-card">
              <div class="pvs-video-wrapper">
                {% if video != blank %}
                  <video
                    class="pvs-video-element"
                    playsinline
                    {% if block.settings.video_behavior == 'autoplay' %}loop muted{% endif %}
                    {% if block.settings.video_controls %}controls{% endif %}
                    preload="none"
                    loading="lazy"
                    data-pvs-video
                    data-behavior="{{ block.settings.video_behavior }}">
                    {% for source in video.sources %}
                      <source data-src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endfor %}
                  </video>
                  {% if block.settings.show_control_button %}
                    {% if block.settings.video_behavior == 'manual' %}
                      <button class="pvs-control-btn pvs-btn-{{ block.settings.button_position }}" data-pvs-play>
                        <svg class="pvs-play-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                        </svg>
                        <svg class="pvs-pause-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z" fill="currentColor"/>
                        </svg>
                      </button>
                    {% elsif block.settings.video_behavior == 'autoplay' %}
                      <button class="pvs-control-btn pvs-btn-{{ block.settings.button_position }}" data-pvs-mute>
                        <svg class="pvs-unmuted-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M3 9V15H7L12 20V4L7 9H3ZM16.5 12C16.5 10.23 15.48 8.71 14 7.97V16.02C15.48 15.29 16.5 13.77 16.5 12ZM14 3.23V5.29C16.89 6.15 19 8.83 19 12C19 15.17 16.89 17.85 14 18.71V20.77C18.01 19.86 21 16.28 21 12C21 7.72 18.01 4.14 14 3.23Z" fill="currentColor"/>
                        </svg>
                        <svg class="pvs-muted-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M16.5 12C16.5 10.23 15.48 8.71 14 7.97V10.18L16.45 12.63C16.48 12.43 16.5 12.22 16.5 12ZM19 12C19 12.94 18.8 13.82 18.46 14.64L19.97 16.15C20.63 14.91 21 13.5 21 12C21 7.72 18.01 4.14 14 3.23V5.29C16.89 6.15 19 8.83 19 12ZM4.27 3L3 4.27L7.73 9H3V15H7L12 20V13.27L16.25 17.52C15.58 18.04 14.83 18.45 14 18.7V20.77C15.38 20.45 16.63 19.81 17.68 18.96L19.73 21L21 19.73L12 10.73L4.27 3ZM12 4L9.91 6.09L12 8.18V4Z" fill="currentColor"/>
                        </svg>
                      </button>
                    {% endif %}
                  {% endif %}
                {% else %}
                  <div class="pvs-video-placeholder">
                    <p>Upload a video</p>
                  </div>
                  {% if block.settings.show_control_button %}
                    {% if block.settings.video_behavior == 'manual' %}
                      <button class="pvs-control-btn pvs-btn-{{ block.settings.button_position }}" data-pvs-play disabled>
                        <svg class="pvs-play-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                        </svg>
                        <svg class="pvs-pause-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z" fill="currentColor"/>
                        </svg>
                      </button>
                    {% elsif block.settings.video_behavior == 'autoplay' %}
                      <button class="pvs-control-btn pvs-btn-{{ block.settings.button_position }}" data-pvs-mute disabled>
                        <svg class="pvs-unmuted-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M3 9V15H7L12 20V4L7 9H3ZM16.5 12C16.5 10.23 15.48 8.71 14 7.97V16.02C15.48 15.29 16.5 13.77 16.5 12ZM14 3.23V5.29C16.89 6.15 19 8.83 19 12C19 15.17 16.89 17.85 14 18.71V20.77C18.01 19.86 21 16.28 21 12C21 7.72 18.01 4.14 14 3.23Z" fill="currentColor"/>
                        </svg>
                        <svg class="pvs-muted-icon" viewBox="0 0 24 24" fill="none">
                          <path d="M16.5 12C16.5 10.23 15.48 8.71 14 7.97V10.18L16.45 12.63C16.48 12.43 16.5 12.22 16.5 12ZM19 12C19 12.94 18.8 13.82 18.46 14.64L19.97 16.15C20.63 14.91 21 13.5 21 12C21 7.72 18.01 4.14 14 3.23V5.29C16.89 6.15 19 8.83 19 12ZM4.27 3L3 4.27L7.73 9H3V15H7L12 20V13.27L16.25 17.52C15.58 18.04 14.83 18.45 14 18.7V20.77C15.38 20.45 16.63 19.81 17.68 18.96L19.73 21L21 19.73L12 10.73L4.27 3ZM12 4L9.91 6.09L12 8.18V4Z" fill="currentColor"/>
                        </svg>
                      </button>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
  .pvs-wrapper {
    width: 100%;
  }

  .pvs-title {
    margin: 0;
    line-height: 1.3;
  }

  .pvs-slider {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .pvs-slider-viewport {
    overflow-x: auto;
    overflow-y: visible;
    width: 100%;
    cursor: grab;
    user-select: none;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: rgba(0,0,0,0.3) rgba(0,0,0,0.1);
  }

  .pvs-slider-viewport::-webkit-scrollbar {
    height: 4px;
  }

  .pvs-slider-viewport::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.05);
    border-radius: 10px;
  }

  .pvs-slider-viewport::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
  }

  .pvs-slider-viewport:active {
    cursor: grabbing;
  }

  .pvs-slider-track {
    display: flex;
    gap: {{ block.settings.slide_gap }}px;
    min-width: 100%;
    width: max-content;
    padding-bottom: 8px;
  }

  .pvs-slide {
    flex: 0 0 {{ block.settings.slide_width }}px;
    min-width: {{ block.settings.slide_width }}px;
    scroll-snap-align: start;
  }

  .pvs-video-card {
    background: {{ block.settings.card_background }};
    border-radius: {{ block.settings.card_border_radius }}px;
    border: {{ block.settings.card_border_width }}px solid {{ block.settings.card_border_color }};
    overflow: hidden;
    height: 100%;
    aspect-ratio: {{ block.settings.video_aspect_ratio }};
  }

  .pvs-video-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .pvs-video-element {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border: none;
  }

  .pvs-control-btn {
    position: absolute;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, opacity 0.5s ease;
    padding: 0;
    width: {{ block.settings.button_width }}px;
    height: {{ block.settings.button_height }}px;
    {% if block.settings.enable_button_bg %}
      background: {{ block.settings.button_bg_color }};
    {% else %}
      background: transparent;
    {% endif %}
    border: {{ block.settings.button_border_width }}px solid {{ block.settings.button_border_color }};
    border-radius: {{ block.settings.button_border_radius }}px;
    color: {{ block.settings.button_icon_color }};
    {% if block.settings.enable_button_blur %}
      backdrop-filter: blur({{ block.settings.button_blur_amount }}px);
      -webkit-backdrop-filter: blur({{ block.settings.button_blur_amount }}px);
    {% endif %}
    opacity: 1;
  }

  .pvs-control-btn.pvs-btn-hidden {
    opacity: 0;
    pointer-events: none;
  }

  .pvs-video-wrapper:hover .pvs-control-btn.pvs-btn-hidden {
    opacity: 1;
    pointer-events: auto;
  }

  .pvs-control-btn.pvs-btn-center {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .pvs-control-btn.pvs-btn-center:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .pvs-control-btn.pvs-btn-custom {
    top: {{ block.settings.button_custom_y }}%;
    left: {{ block.settings.button_custom_x }}%;
  }

  .pvs-control-btn.pvs-btn-custom:hover {
    transform: scale(1.1);
  }

  .pvs-btn-top-left {
    top: 10px;
    left: 10px;
  }

  .pvs-btn-top-right {
    top: 10px;
    right: 10px;
  }

  .pvs-btn-bottom-left {
    bottom: 10px;
    left: 10px;
  }

  .pvs-btn-bottom-right {
    bottom: 10px;
    right: 10px;
  }

  .pvs-control-btn:not(.pvs-btn-center):hover {
    transform: scale(1.1);
  }

  .pvs-play-icon,
  .pvs-pause-icon,
  .pvs-unmuted-icon,
  .pvs-muted-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: {{ block.settings.button_icon_size }}px;
    height: {{ block.settings.button_icon_size }}px;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .pvs-control-btn[data-playing="false"] .pvs-play-icon {
    opacity: 1;
    visibility: visible;
  }

  .pvs-control-btn[data-playing="false"] .pvs-pause-icon {
    opacity: 0;
    visibility: hidden;
  }

  .pvs-control-btn[data-playing="true"] .pvs-play-icon {
    opacity: 0;
    visibility: hidden;
  }

  .pvs-control-btn[data-playing="true"] .pvs-pause-icon {
    opacity: 1;
    visibility: visible;
  }

  .pvs-control-btn[data-muted="false"] .pvs-unmuted-icon {
    opacity: 1;
    visibility: visible;
  }

  .pvs-control-btn[data-muted="false"] .pvs-muted-icon {
    opacity: 0;
    visibility: hidden;
  }

  .pvs-control-btn[data-muted="true"] .pvs-unmuted-icon {
    opacity: 0;
    visibility: hidden;
  }

  .pvs-control-btn[data-muted="true"] .pvs-muted-icon {
    opacity: 1;
    visibility: visible;
  }

  .pvs-video-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
  }

  .pvs-video-placeholder p {
    margin: 0;
    font-size: 14px;
    font-weight: 400;
    color: #666;
  }

  @media screen and (max-width: 749px) {
    .pvs-slide {
      flex: 0 0 {{ block.settings.slide_width_mobile }}px;
      min-width: {{ block.settings.slide_width_mobile }}px;
    }

    .pvs-title {
      font-size: {{ block.settings.title_font_size | times: 0.85 }}px;
    }
  }
</style>

<script>
(function() {
  document.querySelectorAll('[data-pvs-slider]').forEach(slider => {
    const viewport = slider.querySelector('[data-pvs-viewport]');
    const track = slider.querySelector('[data-pvs-track]');
    const videos = slider.querySelectorAll('[data-pvs-video]');
    const playPauseBtns = slider.querySelectorAll('[data-pvs-play-pause]');

    // Lazy load videos with Intersection Observer
    const videoObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const video = entry.target;

          if (!video.hasAttribute('data-loaded')) {
            const sources = video.querySelectorAll('source[data-src]');

            sources.forEach(source => {
              const srcUrl = source.getAttribute('data-src');
              if (srcUrl) {
                source.src = srcUrl;
                source.removeAttribute('data-src');
              }
            });

            video.load();
            video.setAttribute('data-loaded', 'true');

            // Auto-play if behavior is set to autoplay
            const behavior = video.getAttribute('data-behavior');
            if (behavior === 'autoplay') {
              video.play().catch(() => {});
            }
          }
        }
      });
    }, {
      root: null,
      rootMargin: '50px',
      threshold: 0.1
    });

    // Observe all videos
    videos.forEach(video => {
      videoObserver.observe(video);
    });

    // Drag to scroll
    let isDown = false;
    let startX;
    let scrollLeft;

    viewport.addEventListener('mousedown', (e) => {
      isDown = true;
      startX = e.pageX - viewport.offsetLeft;
      scrollLeft = viewport.scrollLeft;
    });

    viewport.addEventListener('mouseleave', () => {
      isDown = false;
    });

    viewport.addEventListener('mouseup', () => {
      isDown = false;
    });

    viewport.addEventListener('mousemove', (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - viewport.offsetLeft;
      const walk = (x - startX) * 2;
      viewport.scrollLeft = scrollLeft - walk;
    });

    // Button auto-hide functionality
    const allControlBtns = slider.querySelectorAll('[data-pvs-play], [data-pvs-mute]');
    const videoWrappers = slider.querySelectorAll('.pvs-video-wrapper');

    videoWrappers.forEach((wrapper, wrapperIndex) => {
      const btn = allControlBtns[wrapperIndex];
      if (!btn) return;

      let hideTimeout;

      const showButton = () => {
        btn.classList.remove('pvs-btn-hidden');
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          btn.classList.add('pvs-btn-hidden');
        }, 2000);
      };

      const resetHideTimer = () => {
        showButton();
      };

      // Show button on any interaction
      wrapper.addEventListener('mousemove', resetHideTimer);
      wrapper.addEventListener('touchstart', resetHideTimer);
      wrapper.addEventListener('click', resetHideTimer);

      // Initially show button then hide after 2 seconds
      setTimeout(() => {
        btn.classList.add('pvs-btn-hidden');
      }, 2000);
    });

    // Play/Pause functionality
    const playBtns = slider.querySelectorAll('[data-pvs-play]');
    playBtns.forEach((btn, index) => {
      const video = videos[index];
      if (!video) return;

      // Set initial playing state
      btn.setAttribute('data-playing', video.paused ? 'false' : 'true');

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (video.paused) {
          video.play();
          btn.setAttribute('data-playing', 'true');
        } else {
          video.pause();
          btn.setAttribute('data-playing', 'false');
        }

        // Show button for 2 seconds after click
        btn.classList.remove('pvs-btn-hidden');
        setTimeout(() => {
          btn.classList.add('pvs-btn-hidden');
        }, 2000);
      });

      // Update button state when video plays/pauses externally
      video.addEventListener('play', () => {
        btn.setAttribute('data-playing', 'true');
      });

      video.addEventListener('pause', () => {
        btn.setAttribute('data-playing', 'false');
      });
    });

    // Mute/Unmute functionality
    const muteBtns = slider.querySelectorAll('[data-pvs-mute]');
    muteBtns.forEach((btn, index) => {
      const video = videos[index];
      if (!video) return;

      // Set initial muted state
      btn.setAttribute('data-muted', video.muted ? 'true' : 'false');

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        video.muted = !video.muted;
        btn.setAttribute('data-muted', video.muted ? 'true' : 'false');

        // Show button for 2 seconds after click
        btn.classList.remove('pvs-btn-hidden');
        setTimeout(() => {
          btn.classList.add('pvs-btn-hidden');
        }, 2000);
      });
    });
  });
})();
</script>
